<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control Live</title>
<style>
:root {
	--bg: #0d1117;
	--surface: #161b22;
	--border: #30363d;
	--text: #e6edf3;
	--text-muted: #8b949e;
	--green: #3fb950;
	--yellow: #d29922;
	--red: #f85149;
	--blue: #58a6ff;
	--purple: #bc8cff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
	overflow: hidden;
	width: 100%;
	max-width: 100vw;
}

body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
	background: var(--bg);
	color: var(--text);
	font-size: 14px;
	line-height: 1.5;
}

.layout {
	display: grid;
	grid-template-rows: auto auto 1fr auto auto auto;
	height: 100vh;
	width: 100vw;
	overflow: hidden;
}

/* Header */
.header {
	background: var(--surface);
	border-bottom: 1px solid var(--border);
	padding: 12px 20px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	flex-wrap: wrap;
	gap: 12px;
}

.header-left {
	display: flex;
	align-items: center;
	gap: 16px;
}

.header h1 {
	font-size: 16px;
	font-weight: 600;
}

.status-badge {
	padding: 2px 10px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: 600;
	text-transform: uppercase;
}
.status-badge.running { background: var(--green); color: #000; }
.status-badge.stopped { background: var(--red); color: #fff; }
.status-badge.completed { background: var(--blue); color: #000; }
.status-badge.paused { background: var(--yellow); color: #000; }
.status-badge.no-mission { background: var(--border); color: var(--text-muted); }

.header-stats {
	display: flex;
	gap: 20px;
	font-size: 13px;
	color: var(--text-muted);
}

.header-stats .stat-value {
	color: var(--text);
	font-weight: 600;
}

/* Main content */
.main {
	display: grid;
	grid-template-columns: 220px 1fr 240px;
	overflow: hidden;
	min-width: 0;
	max-width: 100%;
}

/* Plan tree panel */
.plan-tree {
	border-right: 1px solid var(--border);
	overflow: auto;
	padding: 12px;
	min-height: 0;
	min-width: 0;
}

/* Shared panel heading style */
.panel-heading {
	font-size: 13px;
	text-transform: uppercase;
	color: var(--text-muted);
	margin-bottom: 8px;
	letter-spacing: 0.5px;
}

.workers .panel-heading { margin-bottom: 12px; }

.epoch-node {
	margin-bottom: 8px;
}

.epoch-header {
	display: flex;
	align-items: center;
	gap: 6px;
	cursor: pointer;
	padding: 4px 6px;
	border-radius: 4px;
	font-size: 13px;
	font-weight: 600;
}

.epoch-header:hover { background: var(--border); }

.unit-node {
	position: relative;
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 12px;
	display: flex;
	align-items: center;
	gap: 6px;
	cursor: pointer;
}

.unit-node:hover { background: rgba(255,255,255,0.05); }

.unit-dot {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	flex-shrink: 0;
}
.unit-dot.running { background: var(--yellow); }
.unit-dot.completed, .unit-dot.merged { background: var(--green); }
.unit-dot.failed { background: var(--red); }
.unit-dot.pending { background: var(--text-muted); }
.unit-dot.blocked { background: var(--purple); }

/* Progress bar under epoch header */
.epoch-progress {
	height: 4px;
	background: var(--border);
	border-radius: 2px;
	margin: 4px 6px 2px 6px;
	overflow: hidden;
}

.epoch-progress-fill {
	height: 100%;
	background: var(--green);
	border-radius: 2px;
	transition: width 0.3s ease;
}

/* Tree lines connecting epoch to units */
.epoch-children {
	position: relative;
	margin-left: 12px;
	padding-left: 14px;
	border-left: 1px solid var(--border);
}

.unit-node::before {
	content: "";
	position: absolute;
	left: -14px;
	top: 50%;
	width: 14px;
	height: 1px;
	background: var(--border);
}

.epoch-children .unit-node:last-child::after {
	content: "";
	position: absolute;
	left: -15px;
	top: 50%;
	bottom: -1px;
	width: 1px;
	background: var(--bg);
}

/* Expandable/collapsible toggle */
.epoch-header .toggle {
	width: 16px;
	color: var(--text-muted);
	display: inline-block;
	transition: transform 0.2s ease;
}

.epoch-node.collapsed .epoch-header .toggle {
	transform: rotate(-90deg);
}

.epoch-node.collapsed .epoch-children {
	display: none;
}

.epoch-node.collapsed .epoch-progress {
	display: none;
}

/* Unit duration label */
.unit-duration {
	margin-left: auto;
	flex-shrink: 0;
	font-size: 11px;
	color: var(--text-muted);
}

/* Worker cards panel */
.workers {
	overflow: auto;
	padding: 16px;
	min-height: 0;
	min-width: 0;
}


.worker-grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
	gap: 12px;
}

.worker-card {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 8px;
	padding: 12px;
	cursor: pointer;
	transition: border-color 0.15s;
}

.worker-card:hover { border-color: var(--blue); }

.worker-card.running { border-left: 3px solid var(--yellow); }
.worker-card.completed { border-left: 3px solid var(--green); }
.worker-card.failed { border-left: 3px solid var(--red); }
.worker-card.pending { border-left: 3px solid var(--text-muted); }

.card-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 6px;
}

.card-title {
	font-weight: 600;
	font-size: 13px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	max-width: 200px;
}

.card-status {
	font-size: 11px;
	padding: 1px 6px;
	border-radius: 8px;
	font-weight: 600;
}
.card-status.running { background: rgba(210, 153, 34, 0.2); color: var(--yellow); }
.card-status.completed { background: rgba(63, 185, 80, 0.2); color: var(--green); }
.card-status.failed { background: rgba(248, 81, 73, 0.2); color: var(--red); }
.card-status.pending { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }

.card-meta {
	font-size: 12px;
	color: var(--text-muted);
	margin-bottom: 4px;
}

.card-summary {
	font-size: 12px;
	color: var(--text-muted);
	margin-top: 6px;
	display: none;
}

.worker-card.expanded .card-summary { display: block; }

.output-excerpt {
	font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
	font-size: 11px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 4px;
	padding: 8px;
	max-height: 120px;
	overflow-y: auto;
	white-space: pre-wrap;
	word-break: break-all;
	color: var(--text-muted);
	margin-bottom: 6px;
}

.card-actions {
	display: none;
	margin-top: 8px;
	gap: 6px;
}

.worker-card.expanded .card-actions { display: flex; }

.card-actions button {
	font-size: 11px;
	padding: 3px 10px;
	border-radius: 4px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
}
.card-actions button:hover { background: var(--border); }
.card-actions button.danger { border-color: var(--red); color: var(--red); }
.card-actions button.danger:hover { background: rgba(248, 81, 73, 0.15); }

/* Event log panel */
.event-log {
	border-left: 1px solid var(--border);
	overflow: auto;
	padding: 12px;
	min-height: 0;
	min-width: 0;
}


/* Event filter bar */
.event-filters {
	display: flex;
	flex-wrap: wrap;
	gap: 4px;
	margin-bottom: 10px;
}

.event-filter-btn {
	font-size: 11px;
	padding: 2px 8px;
	border-radius: 10px;
	border: 1px solid var(--border);
	background: transparent;
	color: var(--text-muted);
	cursor: pointer;
	transition: all 0.15s;
	font-weight: 500;
}

.event-filter-btn:hover { background: rgba(255,255,255,0.05); }

.event-filter-btn.active { color: #fff; }
.event-filter-btn.active[data-type="dispatched"] { background: var(--blue); border-color: var(--blue); }
.event-filter-btn.active[data-type="merged"] { background: var(--green); border-color: var(--green); color: #000; }
.event-filter-btn.active[data-type="failed"],
.event-filter-btn.active[data-type="rejected"],
.event-filter-btn.active[data-type="merge_failed"] { background: var(--red); border-color: var(--red); }
.event-filter-btn.active[data-type="retry_queued"] { background: var(--yellow); border-color: var(--yellow); color: #000; }
.event-filter-btn.active[data-type="research_completed"] { background: var(--green); border-color: var(--green); color: #000; }
.event-filter-btn.active[data-type="all"] { background: var(--border); border-color: var(--text-muted); color: var(--text); }

/* Event groups */
.event-group {
	margin-bottom: 2px;
	border-radius: 6px;
	overflow: hidden;
}

.event-group.multi {
	background: rgba(255,255,255,0.02);
	border-left: 2px solid var(--border);
	padding-left: 6px;
	margin-bottom: 6px;
}

.event-group.multi .event-item { border-bottom: none; }

.event-group-label {
	font-size: 10px;
	color: var(--text-muted);
	padding: 2px 4px 0 4px;
	font-weight: 600;
	text-transform: uppercase;
	letter-spacing: 0.3px;
}

/* Event items with severity border */
.event-item {
	padding: 4px 0 4px 8px;
	font-size: 12px;
	display: flex;
	gap: 8px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.5);
	border-left: 3px solid transparent;
	transition: background 0.15s;
}

.event-item:hover { background: rgba(255,255,255,0.02); }

.event-item.severity-success { border-left-color: var(--green); }
.event-item.severity-info { border-left-color: var(--blue); }
.event-item.severity-warning { border-left-color: var(--yellow); }
.event-item.severity-error { border-left-color: var(--red); }

.event-item.filtered-out { display: none; }

.event-time {
	color: var(--text-muted);
	flex-shrink: 0;
	width: 60px;
}

.event-type {
	font-weight: 600;
	flex-shrink: 0;
	width: 80px;
}
.event-type.dispatched { color: var(--blue); }
.event-type.merged,
.event-type.research_completed { color: var(--green); }
.event-type.failed,
.event-type.rejected,
.event-type.merge_failed { color: var(--red); }
.event-type.retry_queued { color: var(--yellow); }

.event-unit {
	color: var(--text-muted);
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

/* Control bar */
.controls {
	background: var(--surface);
	border-top: 1px solid var(--border);
	padding: 10px 20px;
	display: flex;
	gap: 10px;
	align-items: center;
}

.controls button {
	padding: 6px 16px;
	border-radius: 6px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
	font-size: 13px;
	font-weight: 500;
	display: flex;
	align-items: center;
	gap: 6px;
}

.controls button:hover { background: var(--border); }
.controls button.primary { background: var(--blue); color: #000; border-color: var(--blue); }
.controls button.primary:hover { opacity: 0.9; }
.controls button.danger { border-color: var(--red); color: var(--red); }
.controls button.danger:hover { background: rgba(248, 81, 73, 0.15); }
.controls button.warning { border-color: var(--yellow); color: var(--yellow); }
.controls button.warning:hover { background: rgba(210, 153, 34, 0.15); }
.controls button:disabled {
	opacity: 0.35;
	cursor: not-allowed;
	pointer-events: none;
}

.controls .spacer { flex: 1; }

.kbd-hint {
	font-size: 10px;
	background: rgba(255,255,255,0.1);
	padding: 1px 5px;
	border-radius: 3px;
	margin-left: 4px;
	font-family: monospace;
}

/* Confirmation dialog */
.confirm-overlay {
	display: none;
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.6);
	z-index: 200;
	justify-content: center;
	align-items: center;
}
.confirm-overlay.active { display: flex; }
.confirm-dialog {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 12px;
	padding: 24px;
	width: 380px;
	max-width: 90vw;
	text-align: center;
}
.confirm-dialog .confirm-icon {
	font-size: 32px;
	margin-bottom: 12px;
}
.confirm-dialog h3 {
	margin-bottom: 8px;
	font-size: 16px;
}
.confirm-dialog p {
	color: var(--text-muted);
	font-size: 13px;
	margin-bottom: 16px;
}
.confirm-dialog .confirm-actions {
	display: flex;
	justify-content: center;
	gap: 10px;
}
.confirm-dialog .confirm-actions button {
	padding: 8px 20px;
	border-radius: 6px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
	font-size: 13px;
	font-weight: 500;
}
.confirm-dialog .confirm-actions button.confirm-danger {
	background: var(--red);
	color: #fff;
	border-color: var(--red);
}
.confirm-dialog .confirm-actions button:hover { opacity: 0.85; }

/* Toast notifications */
.toast-container {
	position: fixed;
	bottom: 60px;
	right: 20px;
	z-index: 300;
	display: flex;
	flex-direction: column-reverse;
	gap: 8px;
	pointer-events: none;
}
.toast {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 8px;
	padding: 10px 16px;
	font-size: 13px;
	color: var(--text);
	opacity: 0;
	transform: translateY(10px);
	animation: toastIn 0.2s ease forwards, toastOut 0.3s ease 2.2s forwards;
	pointer-events: auto;
	display: flex;
	align-items: center;
	gap: 8px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.toast.success { border-left: 3px solid var(--green); }
.toast.info { border-left: 3px solid var(--blue); }
.toast.warn { border-left: 3px solid var(--yellow); }
@keyframes toastIn {
	to { opacity: 1; transform: translateY(0); }
}
@keyframes toastOut {
	to { opacity: 0; transform: translateY(-10px); }
}
.controls .ws-status {
	font-size: 12px;
	color: var(--text-muted);
}
.controls .ws-status.connected { color: var(--green); }
.controls .ws-status.disconnected { color: var(--red); }

/* Modal */
.modal-overlay {
	display: none;
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.6);
	z-index: 100;
	justify-content: center;
	align-items: center;
}

.modal-overlay.active { display: flex; }

.modal {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 12px;
	padding: 24px;
	width: 400px;
	max-width: 90vw;
}

.modal h3 {
	margin-bottom: 12px;
	font-size: 16px;
}

.modal textarea {
	width: 100%;
	height: 100px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 6px;
	color: var(--text);
	padding: 8px;
	font-size: 13px;
	font-family: inherit;
	resize: vertical;
}

.modal .modal-actions {
	margin-top: 12px;
	display: flex;
	justify-content: flex-end;
	gap: 8px;
}

.modal .modal-actions button {
	padding: 6px 16px;
	border-radius: 6px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
	font-size: 13px;
}
.modal .modal-actions button.primary { background: var(--blue); color: #000; border-color: var(--blue); }

/* Responsive: 2-column -- plan tree + stacked workers/events */
@media (max-width: 1100px) and (min-width: 769px) {
	.main {
		grid-template-columns: 200px 1fr;
		grid-template-rows: 1fr 1fr;
	}
	.plan-tree {
		grid-row: 1 / -1;
	}
	.workers {
		border-bottom: 1px solid var(--border);
	}
	.event-log {
		border-left: none;
		border-top: none;
	}
}

/* Responsive: single column */
@media (max-width: 768px) {
	.main {
		grid-template-columns: 1fr;
		grid-template-rows: minmax(120px, 25vh) minmax(200px, 1fr) minmax(120px, 25vh);
		overflow: hidden;
	}
	.plan-tree {
		border-right: none;
		border-bottom: 1px solid var(--border);
	}
	.event-log {
		border-left: none;
		border-top: 1px solid var(--border);
	}
	.header {
		flex-direction: column;
		align-items: flex-start;
	}
	.header-stats {
		flex-wrap: wrap;
		gap: 10px;
	}
	.controls {
		flex-wrap: wrap;
	}
}

/* Empty state */
.empty-state {
	display: flex;
	justify-content: center;
	align-items: center;
	height: 100%;
	color: var(--text-muted);
	font-size: 14px;
}

/* Mission Statement section */
.mission-statement {
	background: linear-gradient(135deg, rgba(88, 166, 255, 0.12), rgba(188, 140, 255, 0.10));
	border-bottom: 1px solid var(--border);
	padding: 12px 20px;
	max-height: 280px;
	overflow-y: auto;
}

.mission-statement.inactive {
	background: rgba(48, 54, 61, 0.3);
	padding: 10px 20px;
	max-height: none;
	overflow: visible;
}

.mission-statement-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 6px;
}

.mission-statement-label {
	font-size: 11px;
	font-weight: 700;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: var(--blue);
}

.mission-statement.inactive .mission-statement-label {
	color: var(--text-muted);
}

.ambition-dots {
	display: flex;
	align-items: center;
	gap: 3px;
	font-size: 11px;
	color: var(--text-muted);
}

.ambition-dot {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background: var(--border);
}

.ambition-dot.filled {
	background: var(--yellow);
}

.ambition-value {
	margin-left: 4px;
	font-weight: 600;
	color: var(--text);
}

.mission-objective-text {
	font-size: 13px;
	color: var(--text);
	line-height: 1.5;
	white-space: pre-wrap;
	word-break: break-word;
	max-height: 4.5em;
	overflow-y: auto;
}

.mission-statement.inactive .mission-objective-text {
	color: var(--text-muted);
	font-style: italic;
}

.mission-epoch-divider {
	border: none;
	border-top: 1px solid rgba(48, 54, 61, 0.6);
	margin: 8px 0;
}

.mission-epoch-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 6px;
}

.mission-epoch-title {
	font-size: 12px;
	font-weight: 600;
	color: var(--text-muted);
	text-transform: uppercase;
	letter-spacing: 0.3px;
}

.mission-epoch-progress {
	font-size: 12px;
	color: var(--text-muted);
}

.mission-epoch-progress .progress-count {
	color: var(--green);
	font-weight: 600;
}

.mission-unit-list {
	list-style: none;
	margin: 0;
	padding: 0;
}

.mission-unit-item {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 3px 0;
	font-size: 12px;
	cursor: pointer;
	border-radius: 3px;
}

.mission-unit-item:hover {
	background: rgba(255, 255, 255, 0.04);
}

.mission-unit-dot {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	flex-shrink: 0;
}

.mission-unit-dot.completed { background: var(--green); }
.mission-unit-dot.running { background: var(--yellow); }
.mission-unit-dot.claimed { background: var(--yellow); }
.mission-unit-dot.failed { background: var(--red); }
.mission-unit-dot.pending { background: var(--text-muted); }

.mission-unit-title {
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	color: var(--text);
}

.mission-unit-status {
	flex-shrink: 0;
	font-size: 11px;
	font-weight: 500;
}

.mission-unit-status.completed { color: var(--green); }
.mission-unit-status.running { color: var(--yellow); }
.mission-unit-status.claimed { color: var(--yellow); }
.mission-unit-status.failed { color: var(--red); }
.mission-unit-status.pending { color: var(--text-muted); }

@media (max-width: 768px) {
	.ambition-dots { display: none; }
}

/* Enhanced worker card timestamps */
.card-timestamps {
	font-size: 11px;
	color: var(--text-muted);
	margin-top: 4px;
	display: flex;
	gap: 12px;
}

.card-timestamps .ts-label {
	color: var(--text-muted);
	opacity: 0.7;
}

.card-worker-name {
	font-size: 12px;
	color: var(--purple);
	font-weight: 500;
	margin-top: 2px;
}

/* Backlog Queue section */
.backlog-section {
	background: var(--surface);
	border-top: 1px solid var(--border);
}

.backlog-toggle {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 10px 20px;
	cursor: pointer;
	user-select: none;
	font-size: 13px;
	font-weight: 600;
	color: var(--text-muted);
	text-transform: uppercase;
	letter-spacing: 0.5px;
	border: none;
	background: none;
	width: 100%;
	text-align: left;
}

.backlog-toggle:hover {
	color: var(--text);
	background: rgba(255, 255, 255, 0.02);
}

.backlog-toggle .toggle-arrow {
	display: inline-block;
	transition: transform 0.2s ease;
	font-size: 10px;
}

.backlog-section.collapsed .toggle-arrow {
	transform: rotate(-90deg);
}

.backlog-section.collapsed .backlog-content {
	display: none;
}

.backlog-count-badge {
	background: var(--purple);
	color: #fff;
	font-size: 11px;
	font-weight: 600;
	padding: 1px 6px;
	border-radius: 10px;
	margin-left: 4px;
}

.backlog-content {
	padding: 0 20px 12px 20px;
	overflow-x: auto;
	max-height: 300px;
	overflow-y: auto;
}

.backlog-toolbar {
	display: flex;
	gap: 8px;
	padding: 0 0 10px 0;
	align-items: center;
	flex-wrap: wrap;
}

.backlog-toolbar input[type="text"] {
	flex: 1;
	min-width: 120px;
	max-width: 220px;
	padding: 4px 8px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 4px;
	color: var(--text);
	font-size: 12px;
}

.backlog-toolbar select {
	padding: 4px 8px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 4px;
	color: var(--text);
	font-size: 12px;
}

.backlog-toolbar button {
	padding: 4px 10px;
	background: var(--purple);
	color: #fff;
	border: none;
	border-radius: 4px;
	cursor: pointer;
	font-size: 12px;
	font-weight: 600;
}

.backlog-toolbar button:hover {
	opacity: 0.85;
}

.backlog-table {
	width: 100%;
	border-collapse: collapse;
	font-size: 12px;
}

.backlog-table th {
	text-align: left;
	padding: 6px 8px;
	border-bottom: 1px solid var(--border);
	color: var(--text-muted);
	font-size: 11px;
	text-transform: uppercase;
	letter-spacing: 0.3px;
	white-space: nowrap;
}

.backlog-table td {
	padding: 6px 8px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.5);
	vertical-align: top;
}

.backlog-table tr:hover {
	background: rgba(255, 255, 255, 0.02);
}

.backlog-table tr.active-item {
	border-left: 3px solid var(--purple);
}

.backlog-table .bl-title {
	font-weight: 500;
	max-width: 300px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.backlog-status-badge {
	display: inline-block;
	padding: 1px 6px;
	border-radius: 10px;
	font-size: 11px;
	font-weight: 500;
}

.backlog-status-badge.in_progress { background: rgba(88, 166, 255, 0.15); color: var(--blue); }
.backlog-status-badge.pending { background: rgba(210, 153, 34, 0.15); color: var(--yellow); }
.backlog-status-badge.completed { background: rgba(63, 185, 80, 0.15); color: var(--green); }
.backlog-status-badge.deferred { background: rgba(139, 148, 158, 0.15); color: var(--text-muted); }
.backlog-status-badge.rejected { background: rgba(248, 81, 73, 0.15); color: var(--red); }

.backlog-track-badge {
	display: inline-block;
	padding: 1px 6px;
	border-radius: 10px;
	font-size: 11px;
	background: rgba(188, 140, 255, 0.12);
	color: var(--purple);
}

.backlog-actions button {
	padding: 2px 6px;
	font-size: 11px;
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 3px;
	color: var(--text-muted);
	cursor: pointer;
	margin-right: 2px;
}

.backlog-actions button:hover {
	color: var(--text);
	border-color: var(--text-muted);
}

.backlog-actions button.danger:hover {
	color: var(--red);
	border-color: var(--red);
}

.backlog-desc-row td {
	padding: 4px 8px 8px 28px;
	color: var(--text-muted);
	font-size: 11px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.5);
}

.backlog-highlight {
	animation: backlog-flash 1.5s ease-out;
}

@keyframes backlog-flash {
	0% { background: rgba(188, 140, 255, 0.3); }
	100% { background: transparent; }
}

/* Backlog modal */
.backlog-modal-overlay {
	display: none;
	position: fixed;
	inset: 0;
	background: rgba(0, 0, 0, 0.6);
	z-index: 1000;
	justify-content: center;
	align-items: center;
}

.backlog-modal-overlay.active {
	display: flex;
}

.backlog-modal {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 8px;
	padding: 20px;
	width: 480px;
	max-width: 90vw;
	max-height: 80vh;
	overflow-y: auto;
}

.backlog-modal h3 {
	margin-bottom: 12px;
	font-size: 16px;
}

.backlog-modal label {
	display: block;
	margin-top: 10px;
	font-size: 12px;
	color: var(--text-muted);
	font-weight: 500;
}

.backlog-modal input, .backlog-modal textarea, .backlog-modal select {
	width: 100%;
	margin-top: 4px;
	padding: 6px 8px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 4px;
	color: var(--text);
	font-size: 13px;
	font-family: inherit;
}

.backlog-modal textarea {
	resize: vertical;
	min-height: 60px;
}

.backlog-modal .modal-actions {
	display: flex;
	gap: 8px;
	justify-content: flex-end;
	margin-top: 16px;
}

.backlog-modal .modal-actions button {
	padding: 6px 14px;
	border-radius: 4px;
	border: 1px solid var(--border);
	cursor: pointer;
	font-size: 13px;
}

.backlog-modal .modal-actions button.primary {
	background: var(--purple);
	color: #fff;
	border-color: var(--purple);
}

.backlog-modal .modal-actions button.secondary {
	background: var(--surface);
	color: var(--text);
}

/* Backlog link badge in plan tree */
.backlog-link-badge {
	display: inline-block;
	background: var(--purple);
	color: #fff;
	font-size: 9px;
	font-weight: 700;
	width: 14px;
	height: 14px;
	line-height: 14px;
	text-align: center;
	border-radius: 3px;
	margin-left: 4px;
	cursor: pointer;
	flex-shrink: 0;
}

.backlog-link-badge:hover {
	opacity: 0.8;
}

/* Mission History section */
.history-section {
	background: var(--surface);
	border-top: 1px solid var(--border);
}

.history-toggle {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 10px 20px;
	cursor: pointer;
	user-select: none;
	font-size: 13px;
	font-weight: 600;
	color: var(--text-muted);
	text-transform: uppercase;
	letter-spacing: 0.5px;
	border: none;
	background: none;
	width: 100%;
	text-align: left;
}

.history-toggle:hover {
	color: var(--text);
	background: rgba(255, 255, 255, 0.02);
}

.history-toggle .toggle-arrow {
	display: inline-block;
	transition: transform 0.2s ease;
	font-size: 10px;
}

.history-section.collapsed .toggle-arrow {
	transform: rotate(-90deg);
}

.history-section.collapsed .history-content {
	display: none;
}

.history-content {
	padding: 0 20px 12px 20px;
	overflow-x: auto;
}

.history-table {
	width: 100%;
	border-collapse: collapse;
	font-size: 12px;
}

.history-table th {
	text-align: left;
	color: var(--text-muted);
	font-weight: 600;
	font-size: 11px;
	text-transform: uppercase;
	letter-spacing: 0.3px;
	padding: 6px 10px;
	border-bottom: 1px solid var(--border);
}

.history-table td {
	padding: 8px 10px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.5);
	color: var(--text);
	vertical-align: middle;
}

.history-table tr:hover td {
	background: rgba(255, 255, 255, 0.02);
}

.history-objective {
	max-width: 300px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.history-badge {
	display: inline-block;
	padding: 1px 6px;
	border-radius: 8px;
	font-size: 10px;
	font-weight: 600;
	text-transform: uppercase;
}

.history-badge.completed { background: rgba(63, 185, 80, 0.2); color: var(--green); }
.history-badge.failed, .history-badge.stopped { background: rgba(248, 81, 73, 0.2); color: var(--red); }
.history-badge.running { background: rgba(210, 153, 34, 0.2); color: var(--yellow); }

.history-counts {
	display: flex;
	gap: 6px;
	font-size: 11px;
}

.history-counts .hc-merged { color: var(--green); }
.history-counts .hc-failed { color: var(--red); }

.history-detail-btn {
	font-size: 11px;
	padding: 2px 8px;
	border-radius: 4px;
	border: 1px solid var(--border);
	background: transparent;
	color: var(--blue);
	cursor: pointer;
}

.history-detail-btn:hover {
	background: rgba(88, 166, 255, 0.1);
}

.rating-cell { white-space: nowrap; }
.rating-dot {
	display: inline-block; width: 18px; height: 18px; line-height: 18px;
	text-align: center; font-size: 10px; border-radius: 3px;
	background: var(--surface); color: var(--text-secondary);
	cursor: pointer; margin: 0 1px; transition: all 0.15s;
}
.rating-dot:hover { background: rgba(210, 153, 34, 0.4); color: var(--yellow); }
.rating-dot.rating-active { background: rgba(210, 153, 34, 0.5); color: var(--yellow); font-weight: bold; }

.review-scores { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
.review-badge {
	display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 11px;
	font-weight: bold; background: rgba(56, 139, 253, 0.15); color: var(--blue);
}
.review-badge.score-high { background: rgba(63, 185, 80, 0.2); color: var(--green); }
.review-badge.score-low { background: rgba(248, 81, 73, 0.2); color: var(--red); }

.history-empty {
	padding: 16px 0;
	text-align: center;
	color: var(--text-muted);
	font-size: 13px;
}

/* Center panel tabs */
.center-tabs {
	display: flex;
	gap: 0;
	margin-bottom: 12px;
}

.center-tab-btn {
	padding: 4px 14px;
	font-size: 12px;
	font-weight: 600;
	text-transform: uppercase;
	letter-spacing: 0.3px;
	border: 1px solid var(--border);
	background: transparent;
	color: var(--text-muted);
	cursor: pointer;
	transition: all 0.15s;
}

.center-tab-btn:first-child { border-radius: 4px 0 0 4px; }
.center-tab-btn:last-child { border-radius: 0 4px 4px 0; }
.center-tab-btn + .center-tab-btn { border-left: none; }

.center-tab-btn:hover { color: var(--text); background: rgba(255,255,255,0.04); }
.center-tab-btn.active { color: var(--text); background: var(--border); }

.center-panel-content { display: none; }
.center-panel-content.active { display: block; }

/* Timeline Gantt chart */
.timeline-container {
	overflow: auto;
	height: 100%;
	padding-bottom: 12px;
}

.timeline-empty {
	display: flex;
	justify-content: center;
	align-items: center;
	height: 120px;
	color: var(--text-muted);
	font-size: 14px;
}

.gantt-wrapper {
	position: relative;
	min-width: 600px;
}

.gantt-header {
	display: flex;
	position: sticky;
	top: 0;
	z-index: 2;
	background: var(--surface);
	border-bottom: 1px solid var(--border);
}

.gantt-label-col {
	width: 140px;
	min-width: 140px;
	flex-shrink: 0;
	padding: 4px 8px;
	font-size: 11px;
	font-weight: 600;
	color: var(--text-muted);
	text-transform: uppercase;
	letter-spacing: 0.3px;
	border-right: 1px solid var(--border);
}

.gantt-time-header {
	flex: 1;
	display: flex;
	position: relative;
	min-height: 24px;
}

.gantt-time-tick {
	position: absolute;
	top: 0;
	font-size: 10px;
	color: var(--text-muted);
	padding: 4px 0 0 4px;
	white-space: nowrap;
}

.gantt-body {
	position: relative;
}

.gantt-lane {
	display: flex;
	align-items: center;
	min-height: 32px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.3);
}

.gantt-lane:hover {
	background: rgba(255, 255, 255, 0.02);
}

.gantt-lane-label {
	width: 140px;
	min-width: 140px;
	flex-shrink: 0;
	padding: 4px 8px;
	font-size: 12px;
	color: var(--purple);
	font-weight: 500;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	border-right: 1px solid var(--border);
}

.gantt-lane-bars {
	flex: 1;
	position: relative;
	height: 32px;
}

.gantt-bar {
	position: absolute;
	top: 6px;
	height: 20px;
	border-radius: 3px;
	min-width: 4px;
	cursor: pointer;
	display: flex;
	align-items: center;
	padding: 0 6px;
	font-size: 10px;
	font-weight: 600;
	color: #000;
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	transition: opacity 0.15s;
}

.gantt-bar:hover { opacity: 0.85; }

.gantt-bar.running { background: var(--blue); }
.gantt-bar.claimed { background: var(--blue); opacity: 0.7; }
.gantt-bar.completed { background: var(--green); }
.gantt-bar.failed { background: var(--red); color: #fff; }
.gantt-bar.rejected { background: var(--yellow); }
.gantt-bar.pending { background: var(--text-muted); }

.gantt-bar.running { animation: gantt-pulse 2s ease-in-out infinite; }

@keyframes gantt-pulse {
	0%, 100% { opacity: 1; }
	50% { opacity: 0.7; }
}

.gantt-gridline {
	position: absolute;
	top: 0;
	bottom: 0;
	width: 1px;
	background: rgba(48, 54, 61, 0.4);
	z-index: 0;
}

.gantt-now-line {
	position: absolute;
	top: 0;
	bottom: 0;
	width: 2px;
	background: var(--red);
	z-index: 1;
	opacity: 0.6;
}

.gantt-tooltip {
	display: none;
	position: fixed;
	z-index: 500;
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 6px;
	padding: 8px 12px;
	font-size: 12px;
	max-width: 300px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.3);
	pointer-events: none;
}

.gantt-tooltip.visible { display: block; }

.gantt-tooltip .tt-title {
	font-weight: 600;
	margin-bottom: 4px;
}

.gantt-tooltip .tt-meta {
	color: var(--text-muted);
	font-size: 11px;
	line-height: 1.4;
}

.gantt-tooltip .tt-files {
	color: var(--text-muted);
	font-size: 10px;
	margin-top: 4px;
	font-family: monospace;
	word-break: break-all;
}
</style>
</head>
<body>

<div class="layout">
	<!-- Mission Statement -->
	<div class="mission-statement inactive" id="mission-statement">
		<div class="mission-statement-header">
			<span class="mission-statement-label">Mission Statement</span>
			<div class="ambition-dots" id="ambition-dots"></div>
		</div>
		<div class="mission-objective-text" id="mission-objective-text">No active mission</div>
		<div id="mission-epoch-section"></div>
	</div>

	<!-- Header -->
	<div class="header">
		<div class="header-left">
			<h1>Mission Control</h1>
			<span class="status-badge no-mission" id="mission-status">NO MISSION</span>
		</div>
		<div class="header-stats">
			<span>Elapsed: <span class="stat-value" id="elapsed">--</span></span>
			<span>Cost: <span class="stat-value" id="cost">$0.00</span></span>
			<span>Epoch: <span class="stat-value" id="epoch-num">0</span></span>
			<span>Merged: <span class="stat-value" id="merged">0</span></span>
			<span>Failed: <span class="stat-value" id="failed-count">0</span></span>
			<span>Running: <span class="stat-value" id="running-count">0</span></span>
			<span>Pending: <span class="stat-value" id="pending-count">0</span></span>
		</div>
	</div>

	<!-- Main content -->
	<div class="main">
		<!-- Plan tree -->
		<div class="plan-tree">
			<h2 class="panel-heading">Plan Tree</h2>
			<div id="plan-tree-content"></div>
		</div>

		<!-- Worker cards / Timeline -->
		<div class="workers">
			<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
				<h2 class="panel-heading" style="margin-bottom:0">View</h2>
				<div class="center-tabs">
					<button class="center-tab-btn active" onclick="switchCenterTab('units')" data-tab="units">Work Units</button>
					<button class="center-tab-btn" onclick="switchCenterTab('timeline')" data-tab="timeline">Timeline</button>
				</div>
			</div>
			<div id="center-units" class="center-panel-content active">
				<div class="worker-grid" id="worker-grid"></div>
			</div>
			<div id="center-timeline" class="center-panel-content">
				<div class="timeline-container" id="timeline-container">
					<div class="timeline-empty">No timeline data</div>
				</div>
			</div>
		</div>

		<!-- Event log -->
		<div class="event-log">
			<h2 class="panel-heading">Event Log</h2>
			<div class="event-filters" id="event-filters">
				<button class="event-filter-btn active" data-type="all" onclick="toggleEventFilter('all')">All</button>
				<button class="event-filter-btn active" data-type="dispatched" onclick="toggleEventFilter('dispatched')">Dispatched</button>
				<button class="event-filter-btn active" data-type="merged" onclick="toggleEventFilter('merged')">Merged</button>
				<button class="event-filter-btn active" data-type="failed" onclick="toggleEventFilter('failed')">Failed</button>
				<button class="event-filter-btn active" data-type="retry_queued" onclick="toggleEventFilter('retry_queued')">Retry</button>
				<button class="event-filter-btn active" data-type="rejected" onclick="toggleEventFilter('rejected')">Rejected</button>
				<button class="event-filter-btn active" data-type="merge_failed" onclick="toggleEventFilter('merge_failed')">Merge Fail</button>
			</div>
			<div id="event-log-content"></div>
		</div>
	</div>

	<!-- Backlog Queue -->
	<div class="backlog-section collapsed" id="backlog-section">
		<button class="backlog-toggle" onclick="toggleBacklog()">
			<span class="toggle-arrow">&#9662;</span>
			Backlog Queue
			<span class="backlog-count-badge" id="backlog-count">0</span>
		</button>
		<div class="backlog-content" id="backlog-content">
			<div class="backlog-toolbar">
				<input type="text" id="backlog-search" placeholder="Search..." oninput="filterBacklog()">
				<select id="backlog-status-filter" onchange="filterBacklog()">
					<option value="">All Status</option>
					<option value="in_progress">In Progress</option>
					<option value="pending">Pending</option>
					<option value="completed">Completed</option>
					<option value="deferred">Deferred</option>
				</select>
				<select id="backlog-track-filter" onchange="filterBacklog()">
					<option value="">All Tracks</option>
				</select>
				<button onclick="openBacklogModal()">+ Add Item</button>
			</div>
			<div id="backlog-table-container"></div>
		</div>
	</div>

	<!-- Mission History -->
	<div class="history-section collapsed" id="history-section">
		<button class="history-toggle" onclick="toggleHistory()">
			<span class="toggle-arrow">&#9662;</span>
			Mission History
		</button>
		<div class="history-content" id="history-content">
			<div class="history-empty">No mission history</div>
		</div>
	</div>

	<!-- Control bar -->
	<div class="controls">
		<button class="warning" id="btn-pause" onclick="togglePause()" disabled title="Pause mission [P]">Pause <span class="kbd-hint">P</span></button>
		<button class="danger" id="btn-stop" onclick="confirmStop()" disabled title="Stop mission [S]">Stop <span class="kbd-hint">S</span></button>
		<button id="btn-objective" onclick="openAddObjective()" disabled title="Add objective [O]">+ Objective <span class="kbd-hint">O</span></button>
		<div class="spacer"></div>
		<span class="ws-status disconnected" id="ws-status">Disconnected</span>
	</div>
</div>

<!-- Add Objective Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
	<div class="modal">
		<h3>Add Objective</h3>
		<textarea id="objective-input" placeholder="Describe the additional objective..."></textarea>
		<div class="modal-actions">
			<button onclick="closeModal()">Cancel</button>
			<button class="primary" onclick="submitObjective()">Add</button>
		</div>
	</div>
</div>

<!-- Backlog Add/Edit Modal -->
<div class="backlog-modal-overlay" id="backlog-modal-overlay" onclick="if(event.target===this)closeBacklogModal()">
	<div class="backlog-modal">
		<h3 id="backlog-modal-title">Add Backlog Item</h3>
		<input type="hidden" id="backlog-edit-id" value="">
		<label>Title *</label>
		<input type="text" id="bl-input-title" placeholder="Item title">
		<label>Description</label>
		<textarea id="bl-input-desc" placeholder="Details about this item..."></textarea>
		<div style="display:flex;gap:12px">
			<div style="flex:1">
				<label>Impact (1-10)</label>
				<input type="number" id="bl-input-impact" min="1" max="10" value="5">
			</div>
			<div style="flex:1">
				<label>Effort (1-10)</label>
				<input type="number" id="bl-input-effort" min="1" max="10" value="5">
			</div>
		</div>
		<label>Track</label>
		<select id="bl-input-track">
			<option value="">None</option>
			<option value="feature">Feature</option>
			<option value="quality">Quality</option>
			<option value="security">Security</option>
			<option value="docs">Docs</option>
			<option value="infra">Infra</option>
		</select>
		<label>Tags (comma-separated)</label>
		<input type="text" id="bl-input-tags" placeholder="auth, perf, ui">
		<label>Acceptance Criteria</label>
		<textarea id="bl-input-criteria" placeholder="What must be true for this to be done..."></textarea>
		<div class="modal-actions">
			<button class="secondary" onclick="closeBacklogModal()">Cancel</button>
			<button class="primary" onclick="submitBacklogItem()">Save</button>
		</div>
	</div>
</div>

<!-- Confirmation dialog -->
<div class="confirm-overlay" id="confirm-overlay" onclick="if(event.target===this)closeConfirm()">
	<div class="confirm-dialog">
		<div class="confirm-icon" id="confirm-icon"></div>
		<h3 id="confirm-title"></h3>
		<p id="confirm-message"></p>
		<div class="confirm-actions">
			<button onclick="closeConfirm()">Cancel</button>
			<button class="confirm-danger" id="confirm-btn" onclick="executeConfirm()">Confirm</button>
		</div>
	</div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
let ws = null;
let isPaused = false;
let missionActive = false;
let unitTitles = {}; // unit_id -> title cache for event log
let expandedCards = new Set();
let pendingConfirmAction = null;

// Extract auth token from URL query param
const _urlParams = new URLSearchParams(location.search);
const _authToken = _urlParams.get("token") || "";

function _authHeaders() {
	const h = { "Content-Type": "application/json" };
	if (_authToken) h["Authorization"] = `Bearer ${_authToken}`;
	return h;
}

function connect() {
	const protocol = location.protocol === "https:" ? "wss:" : "ws:";
	const tokenParam = _authToken ? `?token=${_authToken}` : "";
	ws = new WebSocket(`${protocol}//${location.host}/ws${tokenParam}`);

	ws.onopen = () => {
		document.getElementById("ws-status").textContent = "Connected";
		document.getElementById("ws-status").className = "ws-status connected";
	};

	ws.onclose = () => {
		document.getElementById("ws-status").textContent = "Disconnected";
		document.getElementById("ws-status").className = "ws-status disconnected";
		setTimeout(connect, 2000);
	};

	ws.onerror = () => ws.close();

	ws.onmessage = (e) => {
		const snapshot = JSON.parse(e.data);
		if (snapshot.reload) {
			location.reload();
			return;
		}
		updateAll(snapshot);
	};
}

let workersByUnit = {};

function updateAll(snapshot) {
	// Build worker lookup by current_unit_id
	workersByUnit = {};
	if (snapshot.workers) {
		for (const w of snapshot.workers) {
			if (w.current_unit_id) {
				workersByUnit[w.current_unit_id] = w;
			}
			// Also index by worker ID (which equals unit ID in 1:1 mapping)
			workersByUnit[w.id] = w;
		}
	}
	unitBacklogMap = snapshot.unit_backlog_map || {};
	updateMissionStatement(snapshot.mission, snapshot.summary, snapshot.current_epoch_units);
	updateHeader(snapshot.mission, snapshot.summary);
	updatePlanTree(snapshot.plan_tree);
	updateWorkerCards(snapshot.units, snapshot.unit_reviews || {});
	updateEventLog(snapshot.events);
	updateHistory(snapshot.history);
	updateBacklog(snapshot.backlog, snapshot.active_backlog_ids);
	updateTimeline(snapshot.timeline);
}

function updateMissionStatement(mission, summary, currentEpochUnits) {
	const section = document.getElementById("mission-statement");
	const objText = document.getElementById("mission-objective-text");
	const ambitionEl = document.getElementById("ambition-dots");
	const epochSection = document.getElementById("mission-epoch-section");

	if (!mission || !mission.objective) {
		section.className = "mission-statement inactive";
		objText.textContent = "No active mission";
		ambitionEl.innerHTML = "";
		epochSection.innerHTML = "";
		return;
	}

	section.className = "mission-statement";
	objText.textContent = mission.objective;

	// Render ambition dots (1-10 scale)
	const ambition = mission.ambition_score || 0;
	if (ambition > 0) {
		let dotsHtml = '<span style="margin-right:2px">Ambition:</span>';
		for (let i = 1; i <= 10; i++) {
			dotsHtml += `<span class="ambition-dot${i <= ambition ? " filled" : ""}"></span>`;
		}
		dotsHtml += `<span class="ambition-value">${ambition}</span>`;
		ambitionEl.innerHTML = dotsHtml;
	} else {
		ambitionEl.innerHTML = "";
	}

	// Render current epoch units
	const units = currentEpochUnits || [];
	if (units.length === 0) {
		epochSection.innerHTML = "";
		return;
	}

	const epochNum = summary ? (summary.current_epoch || 0) : 0;
	const completed = units.filter(u => u.status === "completed").length;
	const total = units.length;

	let html = '<hr class="mission-epoch-divider">';
	html += '<div class="mission-epoch-header">';
	html += `<span class="mission-epoch-title">Current Epoch (${epochNum})</span>`;
	html += `<span class="mission-epoch-progress"><span class="progress-count">${completed}</span> of ${total} complete</span>`;
	html += '</div>';
	html += '<ul class="mission-unit-list">';

	const statusLabels = {
		completed: "completed",
		running: "running",
		claimed: "running",
		failed: "failed",
		pending: "pending",
	};

	for (const unit of units) {
		const dotClass = unit.status || "pending";
		const label = statusLabels[unit.status] || unit.status;
		html += `<li class="mission-unit-item" onclick="scrollToCard('${escapeHtml(unit.id)}')" title="${escapeHtml(unit.files_hint || "")}">`;
		html += `<span class="mission-unit-dot ${dotClass}"></span>`;
		html += `<span class="mission-unit-title">${escapeHtml(unit.title)}</span>`;
		html += `<span class="mission-unit-status ${dotClass}">${label}</span>`;
		html += '</li>';
	}

	html += '</ul>';
	epochSection.innerHTML = html;
}

function updateHeader(mission, summary) {
	const badge = document.getElementById("mission-status");
	const elapsed = document.getElementById("elapsed");
	const cost = document.getElementById("cost");
	const epochEl = document.getElementById("epoch-num");

	updateControlStates(mission);

	if (!mission) {
		badge.textContent = "NO MISSION";
		badge.className = "status-badge no-mission";
		return;
	}

	const status = isPaused ? "paused" : mission.status;
	badge.textContent = status.toUpperCase();
	badge.className = `status-badge ${status}`;

	cost.textContent = `$${(mission.total_cost_usd || 0).toFixed(2)}`;

	if (mission.started_at) {
		const start = new Date(mission.started_at);
		const now = mission.finished_at ? new Date(mission.finished_at) : new Date();
		const diffMs = now - start;
		const mins = Math.floor(diffMs / 60000);
		const secs = Math.floor((diffMs % 60000) / 1000);
		elapsed.textContent = `${mins}m ${secs}s`;
	}

	// Update summary stats from server-side aggregation
	if (summary) {
		document.getElementById("merged").textContent = summary.units_merged || 0;
		document.getElementById("failed-count").textContent = summary.units_failed || 0;
		document.getElementById("running-count").textContent = summary.units_running || 0;
		document.getElementById("pending-count").textContent = summary.units_pending || 0;
		if (epochEl) epochEl.textContent = summary.current_epoch || 0;
	}
}

let collapsedEpochs = new Set();

function updatePlanTree(tree) {
	const container = document.getElementById("plan-tree-content");
	if (!tree || tree.length === 0) {
		container.innerHTML = '<div class="empty-state">No plan data</div>';
		return;
	}

	let html = "";
	for (const epoch of tree) {
		const children = epoch.children || [];
		const total = children.length;
		const merged = children.filter(c => c.status === "completed").length;
		const running = children.filter(c => c.status === "running").length;
		const failed = children.filter(c => c.status === "failed").length;
		const pct = total > 0 ? Math.round((merged / total) * 100) : 0;
		const isCollapsed = collapsedEpochs.has(epoch.number);
		const activeWorkers = children.filter(c => workersByUnit[c.id] && workersByUnit[c.id].status === "working").length;

		html += `<div class="epoch-node${isCollapsed ? " collapsed" : ""}">`;
		html += `<div class="epoch-header" onclick="toggleEpoch(${epoch.number})">`;
		html += `<span class="toggle">&#9662;</span>`;
		html += `<span>Epoch ${epoch.number}</span>`;
		html += `<span style="color:var(--text-muted);font-size:11px;margin-left:auto">`;
		if (activeWorkers) html += `<span style="color:var(--blue)">${activeWorkers}w</span> `;
		if (merged) html += `<span style="color:var(--green)">${merged}m</span> `;
		if (running) html += `<span style="color:var(--yellow)">${running}r</span> `;
		if (failed) html += `<span style="color:var(--red)">${failed}f</span>`;
		html += `</span>`;
		html += `</div>`;

		html += `<div class="epoch-progress"><div class="epoch-progress-fill" style="width:${pct}%"></div></div>`;

		html += `<div class="epoch-children">`;
		for (const unit of children) {
			unitTitles[unit.id] = unit.title;
			const dotClass = unit.status === "completed" ? "completed" : unit.status;
			const duration = formatUnitDuration(unit);
			const linkedBacklog = unitBacklogMap[unit.id] || [];
			html += `<div class="unit-node" onclick="scrollToCard('${unit.id}')" title="${escapeHtml(unit.title)}">`;
			html += `<span class="unit-dot ${dotClass}"></span>`;
			html += `<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(unit.title)}</span>`;
			if (linkedBacklog.length > 0) {
				html += `<span class="backlog-link-badge" onclick="event.stopPropagation();scrollToBacklogItem('${escapeHtml(linkedBacklog[0])}')\" title="Linked to backlog item">B</span>`;
			}
			if (duration) html += `<span class="unit-duration">${duration}</span>`;
			html += `</div>`;
		}
		html += `</div>`;

		html += `</div>`;
	}
	container.innerHTML = html;
}

function toggleEpoch(num) {
	if (collapsedEpochs.has(num)) {
		collapsedEpochs.delete(num);
	} else {
		collapsedEpochs.add(num);
	}
	const nodes = document.querySelectorAll(".epoch-node");
	for (const node of nodes) {
		const header = node.querySelector(".epoch-header");
		if (header && header.textContent.includes(`Epoch ${num}`)) {
			node.classList.toggle("collapsed");
			break;
		}
	}
}

function formatUnitDuration(unit) {
	if (!unit.started_at) return "";
	const start = new Date(unit.started_at);
	const end = unit.finished_at ? new Date(unit.finished_at) : (unit.status === "running" ? new Date() : null);
	if (!end) return "";
	const diffMs = end - start;
	const mins = Math.floor(diffMs / 60000);
	const secs = Math.floor((diffMs % 60000) / 1000);
	if (mins > 0) return `${mins}m ${secs}s`;
	return `${secs}s`;
}

function updateWorkerCards(units, unitReviews) {
	const grid = document.getElementById("worker-grid");

	if (!units || units.length === 0) {
		grid.innerHTML = '<div class="empty-state">No work units</div>';
		return;
	}

	// Sort: running first, then pending, then completed, then failed
	const order = { running: 0, pending: 1, claimed: 1, completed: 3, failed: 4 };
	const sorted = [...units].sort((a, b) => (order[a.status] || 2) - (order[b.status] || 2));

	let html = "";

	for (const unit of sorted) {
		unitTitles[unit.id] = unit.title;

		const expanded = expandedCards.has(unit.id) ? "expanded" : "";
		const elapsed = unit.started_at && unit.status === "running"
			? formatElapsed(unit.started_at)
			: "";
		const worker = workersByUnit[unit.id];

		html += `<div class="worker-card ${unit.status} ${expanded}" id="card-${unit.id}" onclick="toggleCard('${unit.id}')">`;
		html += `<div class="card-header">`;
		html += `<span class="card-title" title="${escapeHtml(unit.title)}">${escapeHtml(unit.title)}</span>`;
		html += `<span class="card-status ${unit.status}">${unit.status}</span>`;
		html += `</div>`;
		if (worker && worker.name) {
			html += `<div class="card-worker-name">${escapeHtml(worker.name)}</div>`;
		} else if (worker && worker.id) {
			html += `<div class="card-worker-name">Worker ${escapeHtml(worker.id.substring(0, 8))}</div>`;
		}

		html += `<div class="card-meta">`;
		html += `${unit.id.substring(0, 8)}`;
		if (unit.attempt > 0) html += ` | attempt ${unit.attempt}/${unit.max_attempts}`;
		if (elapsed) html += ` | ${elapsed}`;
		if (unit.cost_usd > 0) html += ` | $${unit.cost_usd.toFixed(2)}`;
		html += `</div>`;

		if (worker) {
			html += `<div class="card-meta">`;
			if (worker.pid) html += `PID ${worker.pid}`;
			if (worker.workspace_path) html += ` | ${escapeHtml(worker.workspace_path.split("/").slice(-2).join("/"))}`;
			if (worker.last_heartbeat) html += ` | hb ${formatRelativeTime(worker.last_heartbeat)}`;
			html += `</div>`;
		}

		if (unit.files_hint) {
			html += `<div class="card-meta">files: ${escapeHtml(unit.files_hint.substring(0, 60))}</div>`;
		}

		html += `<div class="card-timestamps">`;
		if (unit.started_at) {
			html += `<span><span class="ts-label">Started:</span> ${formatTimestamp(unit.started_at)}</span>`;
		}
		if (unit.finished_at) {
			html += `<span><span class="ts-label">Finished:</span> ${formatTimestamp(unit.finished_at)}</span>`;
		}
		html += `</div>`;

		const review = unitReviews[unit.id];
		if (review) {
			const sc = (v) => v >= 7 ? "score-high" : v <= 4 ? "score-low" : "";
			html += `<div class="card-meta review-scores">`;
			html += `<span class="review-badge ${sc(review.alignment)}" title="Alignment">A:${review.alignment}</span>`;
			html += `<span class="review-badge ${sc(review.approach)}" title="Approach">P:${review.approach}</span>`;
			html += `<span class="review-badge ${sc(review.tests)}" title="Tests">T:${review.tests}</span>`;
			html += `<span style="margin-left:4px;font-size:11px;color:var(--text-muted)">avg ${review.avg.toFixed(1)}</span>`;
			html += `</div>`;
		}

		html += `<div class="card-summary">`;
		if (worker && worker.output_excerpt) {
			html += `<pre class="output-excerpt">${escapeHtml(worker.output_excerpt)}</pre>`;
		}
		if (unit.output_summary) html += `<p>${escapeHtml(unit.output_summary)}</p>`;
		if (unit.description) html += `<p style="margin-top:4px;color:var(--text-muted)">${escapeHtml(unit.description)}</p>`;
		html += `</div>`;

		html += `<div class="card-actions">`;
		if (unit.status === "running") {
			html += `<button class="danger" onclick="event.stopPropagation();cancelUnit('${escapeHtml(unit.id)}')">Cancel</button>`;
		}
		if (unit.status === "failed") {
			html += `<button onclick="event.stopPropagation();forceRetry('${unit.id}')">Force Retry</button>`;
		}
		html += `</div>`;

		html += `</div>`;
	}

	grid.innerHTML = html;
}

let activeEventFilters = new Set(["all", "dispatched", "merged", "failed", "retry_queued", "rejected", "merge_failed"]);
let lastEventData = [];

function updateEventLog(events) {
	const container = document.getElementById("event-log-content");
	if (!events || events.length === 0) {
		container.innerHTML = '<div class="empty-state">No events</div>';
		lastEventData = [];
		return;
	}

	lastEventData = events;

	// Show newest first
	const reversed = [...events].reverse().slice(0, 100);

	// Group consecutive events by unit_id
	const groups = [];
	let currentGroup = null;
	for (const event of reversed) {
		if (currentGroup && currentGroup.unitId === event.work_unit_id) {
			currentGroup.events.push(event);
		} else {
			currentGroup = { unitId: event.work_unit_id, events: [event] };
			groups.push(currentGroup);
		}
	}

	let html = "";
	for (const group of groups) {
		const isMulti = group.events.length > 1;
		const unitTitle = unitTitles[group.unitId] || group.unitId.substring(0, 8);

		if (isMulti) {
			html += `<div class="event-group multi">`;
			html += `<div class="event-group-label">${escapeHtml(unitTitle)}</div>`;
		} else {
			html += `<div class="event-group">`;
		}

		for (const event of group.events) {
			const severity = getSeverityClass(event.event_type);
			const relTime = event.timestamp ? formatRelativeTime(event.timestamp) : "--";
			const evtUnitTitle = unitTitles[event.work_unit_id] || event.work_unit_id.substring(0, 8);
			const isFiltered = !activeEventFilters.has("all") && !activeEventFilters.has(event.event_type);

			html += `<div class="event-item ${severity}${isFiltered ? " filtered-out" : ""}" data-event-type="${event.event_type}" data-timestamp="${event.timestamp || ""}">`;
			html += `<span class="event-time" title="${event.timestamp ? new Date(event.timestamp).toLocaleString() : ""}">${relTime}</span>`;
			html += `<span class="event-type ${event.event_type}">${event.event_type}</span>`;
			if (!isMulti) {
				html += `<span class="event-unit" title="${escapeHtml(evtUnitTitle)}">${escapeHtml(evtUnitTitle)}</span>`;
			}
			html += `</div>`;
		}

		html += `</div>`;
	}
	container.innerHTML = html;
}

function getSeverityClass(eventType) {
	switch (eventType) {
		case "merged":
		case "research_completed":
			return "severity-success";
		case "dispatched":
			return "severity-info";
		case "retry_queued":
			return "severity-warning";
		case "failed":
		case "rejected":
		case "merge_failed":
			return "severity-error";
		default:
			return "severity-info";
	}
}

function formatRelativeTime(isoString) {
	try {
		const then = new Date(isoString);
		const diffMs = Date.now() - then.getTime();
		const diffSec = Math.floor(diffMs / 1000);
		if (diffSec < 5) return "just now";
		if (diffSec < 60) return `${diffSec}s ago`;
		const diffMin = Math.floor(diffSec / 60);
		if (diffMin < 60) return `${diffMin}m ago`;
		const diffHr = Math.floor(diffMin / 60);
		if (diffHr < 24) return `${diffHr}h ago`;
		const diffDay = Math.floor(diffHr / 24);
		return `${diffDay}d ago`;
	} catch {
		return "--";
	}
}

function refreshRelativeTimestamps() {
	const items = document.querySelectorAll("#event-log-content .event-item[data-timestamp]");
	for (const item of items) {
		const ts = item.getAttribute("data-timestamp");
		if (ts) {
			const timeEl = item.querySelector(".event-time");
			if (timeEl) timeEl.textContent = formatRelativeTime(ts);
		}
	}
}

function toggleEventFilter(type) {
	if (type === "all") {
		const allBtn = document.querySelector('.event-filter-btn[data-type="all"]');
		if (activeEventFilters.has("all")) {
			// Deactivate all filters
			activeEventFilters.clear();
			document.querySelectorAll(".event-filter-btn").forEach(b => b.classList.remove("active"));
		} else {
			// Activate all filters
			activeEventFilters = new Set(["all", "dispatched", "merged", "failed", "retry_queued", "rejected", "merge_failed"]);
			document.querySelectorAll(".event-filter-btn").forEach(b => b.classList.add("active"));
		}
	} else {
		const btn = document.querySelector(`.event-filter-btn[data-type="${type}"]`);
		if (activeEventFilters.has(type)) {
			activeEventFilters.delete(type);
			btn.classList.remove("active");
		} else {
			activeEventFilters.add(type);
			btn.classList.add("active");
		}

		// Sync "all" button state
		const allTypes = ["dispatched", "merged", "failed", "retry_queued", "rejected", "merge_failed"];
		const allActive = allTypes.every(t => activeEventFilters.has(t));
		const allBtn = document.querySelector('.event-filter-btn[data-type="all"]');
		if (allActive) {
			activeEventFilters.add("all");
			allBtn.classList.add("active");
		} else {
			activeEventFilters.delete("all");
			allBtn.classList.remove("active");
		}
	}

	applyEventFilters();
}

function applyEventFilters() {
	const showAll = activeEventFilters.has("all") || activeEventFilters.size === 0;
	const items = document.querySelectorAll("#event-log-content .event-item");
	for (const item of items) {
		const type = item.getAttribute("data-event-type");
		if (showAll || activeEventFilters.has(type)) {
			item.classList.remove("filtered-out");
		} else {
			item.classList.add("filtered-out");
		}
	}

	// Hide group labels when all events in a group are filtered out
	const groups = document.querySelectorAll("#event-log-content .event-group");
	for (const group of groups) {
		const visibleItems = group.querySelectorAll(".event-item:not(.filtered-out)");
		group.style.display = visibleItems.length === 0 ? "none" : "";
	}
}

// Control actions
async function sendSignal(type, payload = {}) {
	try {
		await fetch("/api/signal", {
			method: "POST",
			headers: _authHeaders(),
			body: JSON.stringify({ signal_type: type, payload }),
		});
	} catch (e) {
		console.error("Failed to send signal:", e);
		showToast("Failed to send signal", "warn");
	}
}

function togglePause() {
	if (!missionActive) return;
	if (isPaused) {
		sendSignal("resume");
		isPaused = false;
		const btn = document.getElementById("btn-pause");
		btn.innerHTML = 'Pause <span class="kbd-hint">P</span>';
		showToast("Resume signal sent", "info");
	} else {
		sendSignal("pause");
		isPaused = true;
		const btn = document.getElementById("btn-pause");
		btn.innerHTML = 'Resume <span class="kbd-hint">P</span>';
		showToast("Pause signal sent", "info");
	}
}

function confirmStop() {
	if (!missionActive) return;
	showConfirm("Stop Mission", "This will stop all running workers and end the mission. This action cannot be undone.", function() {
		sendSignal("stop");
		showToast("Stop requested", "warn");
	});
}

function cancelUnit(unitId) {
	const title = unitTitles[unitId] || unitId.substring(0, 8);
	showConfirm("Cancel Unit", `Cancel work unit "${title}"? The worker will be terminated.`, function() {
		sendSignal("cancel_unit", { unit_id: unitId });
		showToast("Cancel signal sent for " + title, "info");
	});
}

function forceRetry(unitId) {
	sendSignal("force_retry", { unit_id: unitId });
	const title = unitTitles[unitId] || unitId.substring(0, 8);
	showToast("Retry queued for " + title, "info");
}

// Confirmation dialog
function showConfirm(title, message, onConfirm) {
	document.getElementById("confirm-title").textContent = title;
	document.getElementById("confirm-message").textContent = message;
	pendingConfirmAction = onConfirm;
	document.getElementById("confirm-overlay").classList.add("active");
}

function closeConfirm() {
	document.getElementById("confirm-overlay").classList.remove("active");
	pendingConfirmAction = null;
}

function executeConfirm() {
	if (pendingConfirmAction) pendingConfirmAction();
	closeConfirm();
}

// Toast notifications
function showToast(message, type) {
	type = type || "info";
	const container = document.getElementById("toast-container");
	const toast = document.createElement("div");
	toast.className = "toast " + type;
	toast.textContent = message;
	container.appendChild(toast);
	setTimeout(function() { toast.remove(); }, 2600);
}

// Button state management
function updateControlStates(mission) {
	const active = mission && (mission.status === "running" || mission.status === "paused");
	missionActive = active;
	document.getElementById("btn-pause").disabled = !active;
	document.getElementById("btn-stop").disabled = !active;
	document.getElementById("btn-objective").disabled = !active;
}

// Keyboard shortcuts
document.addEventListener("keydown", function(e) {
	// Ignore when typing in inputs/textareas
	if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
	// Ignore with modifier keys
	if (e.ctrlKey || e.metaKey || e.altKey) return;

	// Close dialogs on Escape
	if (e.key === "Escape") {
		if (document.getElementById("backlog-modal-overlay").classList.contains("active")) {
			closeBacklogModal();
			return;
		}
		if (document.getElementById("confirm-overlay").classList.contains("active")) {
			closeConfirm();
			return;
		}
		if (document.getElementById("modal-overlay").classList.contains("active")) {
			closeModal();
			return;
		}
		return;
	}

	if (e.key === "p" || e.key === "P") {
		e.preventDefault();
		togglePause();
	} else if (e.key === "s" || e.key === "S") {
		e.preventDefault();
		confirmStop();
	} else if (e.key === "o" || e.key === "O") {
		e.preventDefault();
		if (missionActive) openAddObjective();
	} else if (e.key === "t" || e.key === "T") {
		e.preventDefault();
		switchCenterTab(activeCenterTab === "timeline" ? "units" : "timeline");
	}
});

function openAddObjective() {
	document.getElementById("modal-overlay").classList.add("active");
	document.getElementById("objective-input").focus();
}

function closeModal(event) {
	if (!event || event.target === document.getElementById("modal-overlay")) {
		document.getElementById("modal-overlay").classList.remove("active");
		document.getElementById("objective-input").value = "";
	}
}

function submitObjective() {
	const text = document.getElementById("objective-input").value.trim();
	if (text) {
		sendSignal("add_objective", { objective: text });
		closeModal();
	}
}

// Helpers
function toggleCard(id) {
	if (expandedCards.has(id)) {
		expandedCards.delete(id);
	} else {
		expandedCards.add(id);
	}
	const card = document.getElementById(`card-${id}`);
	if (card) card.classList.toggle("expanded");
}

function scrollToCard(id) {
	const card = document.getElementById(`card-${id}`);
	if (card) {
		card.scrollIntoView({ behavior: "smooth", block: "center" });
		if (!expandedCards.has(id)) toggleCard(id);
		card.style.borderColor = "var(--blue)";
		setTimeout(() => card.style.borderColor = "", 2000);
	}
}

function formatElapsed(isoString) {
	const start = new Date(isoString);
	const diff = Date.now() - start.getTime();
	const mins = Math.floor(diff / 60000);
	if (mins < 1) return "<1m";
	return `${mins}m`;
}

function escapeHtml(text) {
	if (!text) return "";
	const div = document.createElement("div");
	div.textContent = text;
	return div.innerHTML;
}

function formatTimestamp(isoString) {
	if (!isoString) return "--";
	try {
		const d = new Date(isoString);
		return d.toLocaleString([], {
			month: "short", day: "numeric",
			hour: "2-digit", minute: "2-digit", second: "2-digit"
		});
	} catch {
		return "--";
	}
}

function formatDuration(startIso, endIso) {
	if (!startIso) return "--";
	try {
		const start = new Date(startIso);
		const end = endIso ? new Date(endIso) : new Date();
		const diffMs = end - start;
		const hrs = Math.floor(diffMs / 3600000);
		const mins = Math.floor((diffMs % 3600000) / 60000);
		if (hrs > 0) return `${hrs}h ${mins}m`;
		return `${mins}m`;
	} catch {
		return "--";
	}
}

function toggleHistory() {
	const section = document.getElementById("history-section");
	section.classList.toggle("collapsed");
}

function updateHistory(history) {
	const container = document.getElementById("history-content");
	if (!history || history.length === 0) {
		container.innerHTML = '<div class="history-empty">No mission history</div>';
		return;
	}

	let html = '<table class="history-table">';
	html += '<thead><tr>';
	html += '<th>Objective</th><th>Status</th><th>Units</th><th>Duration</th><th>Cost</th><th>Rating</th><th></th>';
	html += '</tr></thead><tbody>';

	for (const m of history) {
		const objective = m.objective || "Untitled mission";
		const truncated = objective.length > 80 ? objective.substring(0, 77) + "..." : objective;
		const statusClass = m.status || "completed";
		const merged = m.units_merged || 0;
		const failed = m.units_failed || 0;
		const total = m.units_total || (merged + failed);
		const duration = formatDuration(m.started_at, m.finished_at);
		const cost = m.total_cost_usd != null ? `$${m.total_cost_usd.toFixed(2)}` : "--";

		html += `<tr>`;
		html += `<td><span class="history-objective" title="${escapeHtml(objective)}">${escapeHtml(truncated)}</span></td>`;
		html += `<td><span class="history-badge ${statusClass}">${statusClass}</span></td>`;
		html += `<td><span class="history-counts">`;
		html += `<span class="hc-merged">${merged}m</span>`;
		if (failed > 0) html += ` <span class="hc-failed">${failed}f</span>`;
		html += ` / ${total}`;
		html += `</span></td>`;
		html += `<td>${duration}</td>`;
		html += `<td>${cost}</td>`;
		html += `<td class="rating-cell">`;
		if (m.id) {
			const current = m.trajectory_rating;
			for (let i = 1; i <= 10; i++) {
				const active = current && i <= current ? ' rating-active' : '';
				html += `<span class="rating-dot${active}" data-mission="${escapeHtml(m.id)}" data-score="${i}" onclick="submitRating(this)" title="${i}/10">${i}</span>`;
			}
		}
		html += `</td>`;
		html += `<td>`;
		if (m.id) {
			html += `<button class="history-detail-btn" onclick="event.stopPropagation();viewMissionDetail('${escapeHtml(m.id)}')">Details</button>`;
		}
		html += `</td>`;
		html += `</tr>`;
	}

	html += '</tbody></table>';
	container.innerHTML = html;
}

function submitRating(el) {
	const missionId = el.dataset.mission;
	const score = parseInt(el.dataset.score, 10);
	fetch("/api/rating", {
		method: "POST",
		headers: _authHeaders(),
		body: JSON.stringify({mission_id: missionId, rating: score}),
	})
	.then(r => r.json())
	.then(data => {
		if (data.status === "ok") {
			showToast("Rating saved: " + score + "/10", "info");
			// Update UI immediately
			const dots = el.parentElement.querySelectorAll(".rating-dot");
			dots.forEach(d => {
				const s = parseInt(d.dataset.score, 10);
				d.classList.toggle("rating-active", s <= score);
			});
		} else {
			showToast("Rating failed: " + (data.detail || data.message), "error");
		}
	})
	.catch(err => showToast("Rating error: " + err.message, "error"));
}

function viewMissionDetail(missionId) {
	showToast("Mission details: " + missionId.substring(0, 8), "info");
}

// Update relative timestamps every 15 seconds
setInterval(refreshRelativeTimestamps, 15000);

// -- Backlog Queue --

let backlogData = [];
let backlogActiveIds = [];
let unitBacklogMap = {};
let expandedBacklogDescs = new Set();

function toggleBacklog() {
	const section = document.getElementById("backlog-section");
	section.classList.toggle("collapsed");
}

function updateBacklog(backlog, activeIds) {
	backlogData = backlog || [];
	backlogActiveIds = activeIds || [];
	document.getElementById("backlog-count").textContent = backlogData.length;

	// Populate track filter options dynamically
	const trackFilter = document.getElementById("backlog-track-filter");
	const currentTrack = trackFilter.value;
	const tracks = [...new Set(backlogData.map(b => b.track).filter(Boolean))].sort();
	let trackHtml = '<option value="">All Tracks</option>';
	for (const t of tracks) {
		trackHtml += `<option value="${escapeHtml(t)}"${t === currentTrack ? " selected" : ""}>${escapeHtml(t)}</option>`;
	}
	trackFilter.innerHTML = trackHtml;

	filterBacklog();
}

function filterBacklog() {
	const search = (document.getElementById("backlog-search").value || "").toLowerCase();
	const statusFilter = document.getElementById("backlog-status-filter").value;
	const trackFilter = document.getElementById("backlog-track-filter").value;

	let items = backlogData;
	if (search) {
		items = items.filter(b =>
			b.title.toLowerCase().includes(search) ||
			(b.tags || "").toLowerCase().includes(search) ||
			(b.description || "").toLowerCase().includes(search)
		);
	}
	if (statusFilter) {
		items = items.filter(b => b.status === statusFilter);
	}
	if (trackFilter) {
		items = items.filter(b => b.track === trackFilter);
	}

	renderBacklogTable(items);
}

function renderBacklogTable(items) {
	const container = document.getElementById("backlog-table-container");
	if (!items || items.length === 0) {
		container.innerHTML = '<div style="padding:12px 0;color:var(--text-muted);font-size:13px;text-align:center">No backlog items</div>';
		return;
	}

	// Group by status in order
	const order = ["in_progress", "pending", "completed", "deferred", "rejected"];
	const grouped = {};
	for (const item of items) {
		const s = item.status || "pending";
		if (!grouped[s]) grouped[s] = [];
		grouped[s].push(item);
	}

	let html = '<table class="backlog-table"><thead><tr>';
	html += '<th></th><th>Title</th><th>Score</th><th>Impact</th><th>Effort</th><th>Track</th><th>Status</th><th>Actions</th>';
	html += '</tr></thead><tbody>';

	for (const status of order) {
		const group = grouped[status];
		if (!group) continue;
		for (const b of group) {
			const isActive = backlogActiveIds.includes(b.id);
			const score = b.pinned_score != null ? b.pinned_score : b.priority_score;
			const hasDesc = b.description && b.description.length > 0;
			const isExpanded = expandedBacklogDescs.has(b.id);

			html += `<tr class="${isActive ? "active-item" : ""}" id="backlog-row-${escapeHtml(b.id)}">`;
			html += `<td style="width:16px;cursor:pointer" onclick="toggleBacklogDescription('${escapeHtml(b.id)}')">${hasDesc ? (isExpanded ? "&#9662;" : "&#9656;") : ""}</td>`;
			html += `<td class="bl-title" title="${escapeHtml(b.title)}">${escapeHtml(b.title)}</td>`;
			html += `<td>${score.toFixed(1)}${b.pinned_score != null ? " (P)" : ""}</td>`;
			html += `<td>${b.impact}</td>`;
			html += `<td>${b.effort}</td>`;
			html += `<td>${b.track ? `<span class="backlog-track-badge">${escapeHtml(b.track)}</span>` : ""}</td>`;
			html += `<td><span class="backlog-status-badge ${b.status}">${b.status.replace("_", " ")}</span></td>`;
			html += `<td class="backlog-actions">`;
			html += `<button onclick="event.stopPropagation();openBacklogModal('${escapeHtml(b.id)}')" title="Edit">Ed</button>`;
			if (b.status !== "deferred") html += `<button onclick="event.stopPropagation();deferBacklogItem('${escapeHtml(b.id)}')" title="Defer">Df</button>`;
			html += `<button onclick="event.stopPropagation();pinBacklogItem('${escapeHtml(b.id)}')" title="Pin score">Pin</button>`;
			html += `<button class="danger" onclick="event.stopPropagation();deleteBacklogItem('${escapeHtml(b.id)}')" title="Delete">X</button>`;
			html += `</td></tr>`;

			if (isExpanded && hasDesc) {
				html += `<tr class="backlog-desc-row"><td colspan="8">${escapeHtml(b.description)}</td></tr>`;
			}
		}
	}

	html += '</tbody></table>';
	container.innerHTML = html;
}

function toggleBacklogDescription(id) {
	if (expandedBacklogDescs.has(id)) {
		expandedBacklogDescs.delete(id);
	} else {
		expandedBacklogDescs.add(id);
	}
	filterBacklog();
}

function openBacklogModal(editId) {
	const overlay = document.getElementById("backlog-modal-overlay");
	const titleEl = document.getElementById("backlog-modal-title");
	const editIdEl = document.getElementById("backlog-edit-id");

	if (editId) {
		const item = backlogData.find(b => b.id === editId);
		if (!item) return;
		titleEl.textContent = "Edit Backlog Item";
		editIdEl.value = editId;
		document.getElementById("bl-input-title").value = item.title;
		document.getElementById("bl-input-desc").value = item.description || "";
		document.getElementById("bl-input-impact").value = item.impact;
		document.getElementById("bl-input-effort").value = item.effort;
		document.getElementById("bl-input-track").value = item.track || "";
		document.getElementById("bl-input-tags").value = item.tags || "";
		document.getElementById("bl-input-criteria").value = item.acceptance_criteria || "";
	} else {
		titleEl.textContent = "Add Backlog Item";
		editIdEl.value = "";
		document.getElementById("bl-input-title").value = "";
		document.getElementById("bl-input-desc").value = "";
		document.getElementById("bl-input-impact").value = "5";
		document.getElementById("bl-input-effort").value = "5";
		document.getElementById("bl-input-track").value = "";
		document.getElementById("bl-input-tags").value = "";
		document.getElementById("bl-input-criteria").value = "";
	}
	overlay.classList.add("active");
	document.getElementById("bl-input-title").focus();
}

function closeBacklogModal() {
	document.getElementById("backlog-modal-overlay").classList.remove("active");
}

function submitBacklogItem() {
	const editId = document.getElementById("backlog-edit-id").value;
	const title = document.getElementById("bl-input-title").value.trim();
	if (!title) {
		showToast("Title is required", "warn");
		return;
	}

	const payload = {
		title: title,
		description: document.getElementById("bl-input-desc").value.trim(),
		impact: parseInt(document.getElementById("bl-input-impact").value) || 5,
		effort: parseInt(document.getElementById("bl-input-effort").value) || 5,
		track: document.getElementById("bl-input-track").value,
		tags: document.getElementById("bl-input-tags").value.trim(),
		acceptance_criteria: document.getElementById("bl-input-criteria").value.trim(),
	};

	const url = editId ? `/api/backlog/${editId}` : "/api/backlog";
	const method = editId ? "PATCH" : "POST";

	fetch(url, {
		method: method,
		headers: _authHeaders(),
		body: JSON.stringify(payload),
	})
	.then(r => r.json())
	.then(data => {
		if (data.status === "ok") {
			showToast(editId ? "Item updated" : "Item created", "info");
			closeBacklogModal();
		} else {
			showToast("Error: " + (data.detail || "Unknown"), "error");
		}
	})
	.catch(err => showToast("Error: " + err.message, "error"));
}

function deferBacklogItem(id) {
	fetch(`/api/backlog/${id}/defer`, { method: "POST", headers: _authHeaders() })
		.then(r => r.json())
		.then(data => {
			if (data.status === "ok") showToast("Item deferred", "info");
		})
		.catch(err => showToast("Error: " + err.message, "error"));
}

function pinBacklogItem(id) {
	const score = prompt("Enter pinned priority score:");
	if (score === null) return;
	const num = parseFloat(score);
	if (isNaN(num)) {
		showToast("Invalid score", "warn");
		return;
	}
	fetch(`/api/backlog/${id}/pin`, {
		method: "POST",
		headers: _authHeaders(),
		body: JSON.stringify({ score: num }),
	})
	.then(r => r.json())
	.then(data => {
		if (data.status === "ok") showToast("Score pinned: " + num.toFixed(1), "info");
	})
	.catch(err => showToast("Error: " + err.message, "error"));
}

function deleteBacklogItem(id) {
	showConfirm("Delete Backlog Item", "This will mark the item as rejected. Continue?", function() {
		fetch(`/api/backlog/${id}`, { method: "DELETE", headers: _authHeaders() })
			.then(r => r.json())
			.then(data => {
				if (data.status === "ok") showToast("Item deleted", "info");
			})
			.catch(err => showToast("Error: " + err.message, "error"));
	});
}

function scrollToBacklogItem(id) {
	const section = document.getElementById("backlog-section");
	if (section.classList.contains("collapsed")) {
		section.classList.remove("collapsed");
	}
	setTimeout(function() {
		const row = document.getElementById("backlog-row-" + id);
		if (row) {
			row.scrollIntoView({ behavior: "smooth", block: "center" });
			row.classList.add("backlog-highlight");
			setTimeout(() => row.classList.remove("backlog-highlight"), 1500);
		}
	}, 100);
}

// -- Center panel tab switching --

let activeCenterTab = "units";

function switchCenterTab(tab) {
	activeCenterTab = tab;
	document.querySelectorAll(".center-tab-btn").forEach(b => {
		b.classList.toggle("active", b.dataset.tab === tab);
	});
	document.getElementById("center-units").classList.toggle("active", tab === "units");
	document.getElementById("center-timeline").classList.toggle("active", tab === "timeline");
}

// -- Timeline Gantt rendering --

let lastTimelineData = [];
const ganttTooltip = document.createElement("div");
ganttTooltip.className = "gantt-tooltip";
document.body.appendChild(ganttTooltip);

function updateTimeline(timeline) {
	lastTimelineData = timeline || [];
	renderGantt(lastTimelineData);
}

function renderGantt(entries) {
	const container = document.getElementById("timeline-container");
	if (!entries || entries.length === 0) {
		container.innerHTML = '<div class="timeline-empty">No timeline data</div>';
		return;
	}

	const now = Date.now();

	// Parse times
	const parsed = entries.map(e => ({
		...e,
		startMs: new Date(e.start_time).getTime(),
		endMs: e.end_time ? new Date(e.end_time).getTime() : (e.status === "running" || e.status === "claimed" ? now : new Date(e.start_time).getTime() + 60000),
	}));

	// Compute time range
	let minTime = Infinity, maxTime = -Infinity;
	for (const e of parsed) {
		if (e.startMs < minTime) minTime = e.startMs;
		if (e.endMs > maxTime) maxTime = e.endMs;
	}
	// Extend slightly for padding
	const range = maxTime - minTime || 60000;
	const padded = range * 0.05;
	minTime -= padded;
	maxTime += padded;
	const totalRange = maxTime - minTime;

	// Group by worker
	const workerMap = new Map();
	for (const e of parsed) {
		const wid = e.worker_id || "unassigned";
		if (!workerMap.has(wid)) workerMap.set(wid, []);
		workerMap.get(wid).push(e);
	}

	// Sort workers by earliest start
	const workers = [...workerMap.entries()].sort((a, b) => {
		const aMin = Math.min(...a[1].map(e => e.startMs));
		const bMin = Math.min(...b[1].map(e => e.startMs));
		return aMin - bMin;
	});

	// Time ticks (~6-8 ticks)
	const tickCount = 7;
	const tickInterval = totalRange / tickCount;

	// Build HTML
	let html = '<div class="gantt-wrapper">';

	// Header
	html += '<div class="gantt-header">';
	html += '<div class="gantt-label-col">Worker</div>';
	html += '<div class="gantt-time-header">';
	for (let i = 0; i <= tickCount; i++) {
		const t = minTime + i * tickInterval;
		const pct = ((t - minTime) / totalRange) * 100;
		const d = new Date(t);
		const label = d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
		html += `<span class="gantt-time-tick" style="left:${pct}%">${label}</span>`;
	}
	html += '</div></div>';

	// Body
	html += '<div class="gantt-body">';

	for (const [wid, entries] of workers) {
		const label = wid === "unassigned" ? "Unassigned" : wid.substring(0, 10);
		html += '<div class="gantt-lane">';
		html += `<div class="gantt-lane-label" title="${escapeHtml(wid)}">${escapeHtml(label)}</div>`;
		html += '<div class="gantt-lane-bars">';

		// Gridlines
		for (let i = 0; i <= tickCount; i++) {
			const t = minTime + i * tickInterval;
			const pct = ((t - minTime) / totalRange) * 100;
			html += `<div class="gantt-gridline" style="left:${pct}%"></div>`;
		}

		// Now line
		if (now >= minTime && now <= maxTime) {
			const nowPct = ((now - minTime) / totalRange) * 100;
			html += `<div class="gantt-now-line" style="left:${nowPct}%"></div>`;
		}

		// Bars
		for (const e of entries) {
			const left = ((e.startMs - minTime) / totalRange) * 100;
			const width = Math.max(((e.endMs - e.startMs) / totalRange) * 100, 0.5);
			const title = e.title || e.unit_id.substring(0, 8);
			const duration = formatDuration(e.start_time, e.end_time);
			const filesJson = escapeHtml(JSON.stringify(e.files_changed || []));
			html += `<div class="gantt-bar ${e.status}" style="left:${left}%;width:${width}%"
				data-title="${escapeHtml(e.title)}"
				data-unit-id="${escapeHtml(e.unit_id)}"
				data-status="${e.status}"
				data-duration="${duration}"
				data-files="${filesJson}"
				data-start="${e.start_time}"
				data-end="${e.end_time || ""}"
				onmouseenter="showGanttTooltip(event,this)"
				onmousemove="moveGanttTooltip(event)"
				onmouseleave="hideGanttTooltip()"
				onclick="scrollToCard('${escapeHtml(e.unit_id)}')"
			>${escapeHtml(title)}</div>`;
		}

		html += '</div></div>';
	}

	html += '</div></div>';
	container.innerHTML = html;
}

function showGanttTooltip(event, el) {
	const title = el.dataset.title;
	const status = el.dataset.status;
	const duration = el.dataset.duration;
	const start = el.dataset.start;
	const end = el.dataset.end;
	let files = [];
	try { files = JSON.parse(el.dataset.files.replace(/&quot;/g, '"').replace(/&amp;/g, '&')); } catch {}

	let html = `<div class="tt-title">${escapeHtml(title)}</div>`;
	html += `<div class="tt-meta">`;
	html += `Status: <strong>${status}</strong><br>`;
	html += `Duration: ${duration}<br>`;
	if (start) html += `Start: ${formatTimestamp(start)}<br>`;
	if (end) html += `End: ${formatTimestamp(end)}`;
	html += `</div>`;
	if (files.length > 0) {
		html += `<div class="tt-files">${files.slice(0, 5).map(f => escapeHtml(f)).join("<br>")}`;
		if (files.length > 5) html += `<br>...+${files.length - 5} more`;
		html += `</div>`;
	}

	ganttTooltip.innerHTML = html;
	ganttTooltip.classList.add("visible");
	moveGanttTooltip(event);
}

function moveGanttTooltip(event) {
	const x = event.clientX + 12;
	const y = event.clientY + 12;
	ganttTooltip.style.left = x + "px";
	ganttTooltip.style.top = y + "px";
}

function hideGanttTooltip() {
	ganttTooltip.classList.remove("visible");
}

// Start
connect();
</script>
</body>
</html>
