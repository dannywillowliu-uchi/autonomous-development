<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control Live</title>
<style>
:root {
	--bg: #0d1117;
	--surface: #161b22;
	--border: #30363d;
	--text: #e6edf3;
	--text-muted: #8b949e;
	--green: #3fb950;
	--yellow: #d29922;
	--red: #f85149;
	--blue: #58a6ff;
	--purple: #bc8cff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
	background: var(--bg);
	color: var(--text);
	font-size: 14px;
	line-height: 1.5;
}

.layout {
	display: grid;
	grid-template-rows: auto auto 1fr auto auto;
	height: 100vh;
}

/* Header */
.header {
	background: var(--surface);
	border-bottom: 1px solid var(--border);
	padding: 12px 20px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	flex-wrap: wrap;
	gap: 12px;
}

.header-left {
	display: flex;
	align-items: center;
	gap: 16px;
}

.header h1 {
	font-size: 16px;
	font-weight: 600;
}

.status-badge {
	padding: 2px 10px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: 600;
	text-transform: uppercase;
}
.status-badge.running { background: var(--green); color: #000; }
.status-badge.stopped { background: var(--red); color: #fff; }
.status-badge.completed { background: var(--blue); color: #000; }
.status-badge.paused { background: var(--yellow); color: #000; }
.status-badge.no-mission { background: var(--border); color: var(--text-muted); }

.header-stats {
	display: flex;
	gap: 20px;
	font-size: 13px;
	color: var(--text-muted);
}

.header-stats .stat-value {
	color: var(--text);
	font-weight: 600;
}

/* Main content */
.main {
	display: grid;
	grid-template-columns: minmax(200px, 280px) minmax(300px, 1fr) minmax(220px, 320px);
	overflow: hidden;
}

/* Plan tree panel */
.plan-tree {
	border-right: 1px solid var(--border);
	overflow-y: auto;
	padding: 12px;
	min-height: 0;
}

.plan-tree h2 {
	font-size: 13px;
	text-transform: uppercase;
	color: var(--text-muted);
	margin-bottom: 8px;
	letter-spacing: 0.5px;
}

.epoch-node {
	margin-bottom: 8px;
}

.epoch-header {
	display: flex;
	align-items: center;
	gap: 6px;
	cursor: pointer;
	padding: 4px 6px;
	border-radius: 4px;
	font-size: 13px;
	font-weight: 600;
}

.epoch-header:hover { background: var(--border); }

.unit-node {
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 12px;
	display: flex;
	align-items: center;
	gap: 6px;
	cursor: pointer;
}

.unit-node:hover { background: rgba(255,255,255,0.05); }

.unit-dot {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	flex-shrink: 0;
}
.unit-dot.running { background: var(--yellow); }
.unit-dot.completed, .unit-dot.merged { background: var(--green); }
.unit-dot.failed { background: var(--red); }
.unit-dot.pending { background: var(--text-muted); }
.unit-dot.blocked { background: var(--purple); }

/* Progress bar under epoch header */
.epoch-progress {
	height: 4px;
	background: var(--border);
	border-radius: 2px;
	margin: 4px 6px 2px 6px;
	overflow: hidden;
}

.epoch-progress-fill {
	height: 100%;
	background: var(--green);
	border-radius: 2px;
	transition: width 0.3s ease;
}

/* Tree lines connecting epoch to units */
.epoch-children {
	position: relative;
	margin-left: 12px;
	padding-left: 14px;
	border-left: 1px solid var(--border);
}

.unit-node {
	position: relative;
}

.unit-node::before {
	content: "";
	position: absolute;
	left: -14px;
	top: 50%;
	width: 14px;
	height: 1px;
	background: var(--border);
}

.epoch-children .unit-node:last-child::after {
	content: "";
	position: absolute;
	left: -15px;
	top: 50%;
	bottom: -1px;
	width: 1px;
	background: var(--bg);
}

/* Expandable/collapsible toggle */
.epoch-header .toggle {
	width: 16px;
	color: var(--text-muted);
	display: inline-block;
	transition: transform 0.2s ease;
}

.epoch-node.collapsed .epoch-header .toggle {
	transform: rotate(-90deg);
}

.epoch-node.collapsed .epoch-children {
	display: none;
}

.epoch-node.collapsed .epoch-progress {
	display: none;
}

/* Unit duration label */
.unit-duration {
	margin-left: auto;
	flex-shrink: 0;
	font-size: 11px;
	color: var(--text-muted);
}

/* Worker cards panel */
.workers {
	overflow-y: auto;
	padding: 16px;
	min-height: 0;
}

.workers h2 {
	font-size: 13px;
	text-transform: uppercase;
	color: var(--text-muted);
	margin-bottom: 12px;
	letter-spacing: 0.5px;
}

.worker-grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
	gap: 12px;
}

.worker-card {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 8px;
	padding: 12px;
	cursor: pointer;
	transition: border-color 0.15s;
}

.worker-card:hover { border-color: var(--blue); }

.worker-card.running { border-left: 3px solid var(--yellow); }
.worker-card.completed { border-left: 3px solid var(--green); }
.worker-card.failed { border-left: 3px solid var(--red); }
.worker-card.pending { border-left: 3px solid var(--text-muted); }

.card-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 6px;
}

.card-title {
	font-weight: 600;
	font-size: 13px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	max-width: 200px;
}

.card-status {
	font-size: 11px;
	padding: 1px 6px;
	border-radius: 8px;
	font-weight: 600;
}
.card-status.running { background: rgba(210, 153, 34, 0.2); color: var(--yellow); }
.card-status.completed { background: rgba(63, 185, 80, 0.2); color: var(--green); }
.card-status.failed { background: rgba(248, 81, 73, 0.2); color: var(--red); }
.card-status.pending { background: rgba(139, 148, 158, 0.2); color: var(--text-muted); }

.card-meta {
	font-size: 12px;
	color: var(--text-muted);
	margin-bottom: 4px;
}

.card-summary {
	font-size: 12px;
	color: var(--text-muted);
	margin-top: 6px;
	display: none;
}

.worker-card.expanded .card-summary { display: block; }

.output-excerpt {
	font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
	font-size: 11px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 4px;
	padding: 8px;
	max-height: 120px;
	overflow-y: auto;
	white-space: pre-wrap;
	word-break: break-all;
	color: var(--text-muted);
	margin-bottom: 6px;
}

.card-actions {
	display: none;
	margin-top: 8px;
	gap: 6px;
}

.worker-card.expanded .card-actions { display: flex; }

.card-actions button {
	font-size: 11px;
	padding: 3px 10px;
	border-radius: 4px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
}
.card-actions button:hover { background: var(--border); }
.card-actions button.danger { border-color: var(--red); color: var(--red); }
.card-actions button.danger:hover { background: rgba(248, 81, 73, 0.15); }

/* Event log panel */
.event-log {
	border-left: 1px solid var(--border);
	overflow-y: auto;
	padding: 12px;
	min-height: 0;
}

.event-log h2 {
	font-size: 13px;
	text-transform: uppercase;
	color: var(--text-muted);
	margin-bottom: 8px;
	letter-spacing: 0.5px;
}

/* Event filter bar */
.event-filters {
	display: flex;
	flex-wrap: wrap;
	gap: 4px;
	margin-bottom: 10px;
}

.event-filter-btn {
	font-size: 11px;
	padding: 2px 8px;
	border-radius: 10px;
	border: 1px solid var(--border);
	background: transparent;
	color: var(--text-muted);
	cursor: pointer;
	transition: all 0.15s;
	font-weight: 500;
}

.event-filter-btn:hover { background: rgba(255,255,255,0.05); }

.event-filter-btn.active { color: #fff; }
.event-filter-btn.active[data-type="dispatched"] { background: var(--blue); border-color: var(--blue); }
.event-filter-btn.active[data-type="merged"] { background: var(--green); border-color: var(--green); color: #000; }
.event-filter-btn.active[data-type="failed"] { background: var(--red); border-color: var(--red); }
.event-filter-btn.active[data-type="retry_queued"] { background: var(--yellow); border-color: var(--yellow); color: #000; }
.event-filter-btn.active[data-type="rejected"] { background: var(--red); border-color: var(--red); }
.event-filter-btn.active[data-type="merge_failed"] { background: var(--red); border-color: var(--red); }
.event-filter-btn.active[data-type="research_completed"] { background: var(--green); border-color: var(--green); color: #000; }
.event-filter-btn.active[data-type="all"] { background: var(--border); border-color: var(--text-muted); color: var(--text); }

/* Event groups */
.event-group {
	margin-bottom: 2px;
	border-radius: 6px;
	overflow: hidden;
}

.event-group.multi {
	background: rgba(255,255,255,0.02);
	border-left: 2px solid var(--border);
	padding-left: 6px;
	margin-bottom: 6px;
}

.event-group.multi .event-item { border-bottom: none; }
.event-group.multi .event-item:last-child { border-bottom: none; }

.event-group-label {
	font-size: 10px;
	color: var(--text-muted);
	padding: 2px 4px 0 4px;
	font-weight: 600;
	text-transform: uppercase;
	letter-spacing: 0.3px;
}

/* Event items with severity border */
.event-item {
	padding: 4px 0 4px 8px;
	font-size: 12px;
	display: flex;
	gap: 8px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.5);
	border-left: 3px solid transparent;
	transition: background 0.15s;
}

.event-item:hover { background: rgba(255,255,255,0.02); }

.event-item.severity-success { border-left-color: var(--green); }
.event-item.severity-info { border-left-color: var(--blue); }
.event-item.severity-warning { border-left-color: var(--yellow); }
.event-item.severity-error { border-left-color: var(--red); }

.event-item.filtered-out { display: none; }

.event-time {
	color: var(--text-muted);
	flex-shrink: 0;
	width: 60px;
}

.event-type {
	font-weight: 600;
	flex-shrink: 0;
	width: 80px;
}
.event-type.dispatched { color: var(--blue); }
.event-type.merged, .event-type.research_completed { color: var(--green); }
.event-type.failed, .event-type.rejected, .event-type.merge_failed { color: var(--red); }
.event-type.retry_queued { color: var(--yellow); }

.event-unit {
	color: var(--text-muted);
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

/* Control bar */
.controls {
	background: var(--surface);
	border-top: 1px solid var(--border);
	padding: 10px 20px;
	display: flex;
	gap: 10px;
	align-items: center;
}

.controls button {
	padding: 6px 16px;
	border-radius: 6px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
	font-size: 13px;
	font-weight: 500;
	display: flex;
	align-items: center;
	gap: 6px;
}

.controls button:hover { background: var(--border); }
.controls button.primary { background: var(--blue); color: #000; border-color: var(--blue); }
.controls button.primary:hover { opacity: 0.9; }
.controls button.danger { border-color: var(--red); color: var(--red); }
.controls button.danger:hover { background: rgba(248, 81, 73, 0.15); }
.controls button.warning { border-color: var(--yellow); color: var(--yellow); }
.controls button.warning:hover { background: rgba(210, 153, 34, 0.15); }
.controls button:disabled {
	opacity: 0.35;
	cursor: not-allowed;
	pointer-events: none;
}

.controls .spacer { flex: 1; }

.kbd-hint {
	font-size: 10px;
	background: rgba(255,255,255,0.1);
	padding: 1px 5px;
	border-radius: 3px;
	margin-left: 4px;
	font-family: monospace;
}

/* Confirmation dialog */
.confirm-overlay {
	display: none;
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.6);
	z-index: 200;
	justify-content: center;
	align-items: center;
}
.confirm-overlay.active { display: flex; }
.confirm-dialog {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 12px;
	padding: 24px;
	width: 380px;
	max-width: 90vw;
	text-align: center;
}
.confirm-dialog .confirm-icon {
	font-size: 32px;
	margin-bottom: 12px;
}
.confirm-dialog h3 {
	margin-bottom: 8px;
	font-size: 16px;
}
.confirm-dialog p {
	color: var(--text-muted);
	font-size: 13px;
	margin-bottom: 16px;
}
.confirm-dialog .confirm-actions {
	display: flex;
	justify-content: center;
	gap: 10px;
}
.confirm-dialog .confirm-actions button {
	padding: 8px 20px;
	border-radius: 6px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
	font-size: 13px;
	font-weight: 500;
}
.confirm-dialog .confirm-actions button.confirm-danger {
	background: var(--red);
	color: #fff;
	border-color: var(--red);
}
.confirm-dialog .confirm-actions button:hover { opacity: 0.85; }

/* Toast notifications */
.toast-container {
	position: fixed;
	bottom: 60px;
	right: 20px;
	z-index: 300;
	display: flex;
	flex-direction: column-reverse;
	gap: 8px;
	pointer-events: none;
}
.toast {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 8px;
	padding: 10px 16px;
	font-size: 13px;
	color: var(--text);
	opacity: 0;
	transform: translateY(10px);
	animation: toastIn 0.2s ease forwards, toastOut 0.3s ease 2.2s forwards;
	pointer-events: auto;
	display: flex;
	align-items: center;
	gap: 8px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.toast.success { border-left: 3px solid var(--green); }
.toast.info { border-left: 3px solid var(--blue); }
.toast.warn { border-left: 3px solid var(--yellow); }
@keyframes toastIn {
	to { opacity: 1; transform: translateY(0); }
}
@keyframes toastOut {
	to { opacity: 0; transform: translateY(-10px); }
}
.controls .ws-status {
	font-size: 12px;
	color: var(--text-muted);
}
.controls .ws-status.connected { color: var(--green); }
.controls .ws-status.disconnected { color: var(--red); }

/* Modal */
.modal-overlay {
	display: none;
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.6);
	z-index: 100;
	justify-content: center;
	align-items: center;
}

.modal-overlay.active { display: flex; }

.modal {
	background: var(--surface);
	border: 1px solid var(--border);
	border-radius: 12px;
	padding: 24px;
	width: 400px;
	max-width: 90vw;
}

.modal h3 {
	margin-bottom: 12px;
	font-size: 16px;
}

.modal textarea {
	width: 100%;
	height: 100px;
	background: var(--bg);
	border: 1px solid var(--border);
	border-radius: 6px;
	color: var(--text);
	padding: 8px;
	font-size: 13px;
	font-family: inherit;
	resize: vertical;
}

.modal .modal-actions {
	margin-top: 12px;
	display: flex;
	justify-content: flex-end;
	gap: 8px;
}

.modal .modal-actions button {
	padding: 6px 16px;
	border-radius: 6px;
	border: 1px solid var(--border);
	background: var(--surface);
	color: var(--text);
	cursor: pointer;
	font-size: 13px;
}
.modal .modal-actions button.primary { background: var(--blue); color: #000; border-color: var(--blue); }

/* Responsive: 2-column -- plan tree + stacked workers/events */
@media (max-width: 1024px) and (min-width: 769px) {
	.main {
		grid-template-columns: minmax(200px, 260px) 1fr;
		grid-template-rows: 1fr 1fr;
	}
	.plan-tree {
		grid-row: 1 / -1;
	}
	.workers {
		border-bottom: 1px solid var(--border);
	}
	.event-log {
		border-left: none;
		border-top: none;
	}
}

/* Responsive: single column */
@media (max-width: 768px) {
	.main {
		grid-template-columns: 1fr;
		grid-template-rows: minmax(120px, 25vh) minmax(200px, 1fr) minmax(120px, 25vh);
		overflow: hidden;
	}
	.plan-tree {
		border-right: none;
		border-bottom: 1px solid var(--border);
	}
	.event-log {
		border-left: none;
		border-top: 1px solid var(--border);
	}
	.header {
		flex-direction: column;
		align-items: flex-start;
	}
	.header-stats {
		flex-wrap: wrap;
		gap: 10px;
	}
	.controls {
		flex-wrap: wrap;
	}
}

/* Empty state */
.empty-state {
	display: flex;
	justify-content: center;
	align-items: center;
	height: 100%;
	color: var(--text-muted);
	font-size: 14px;
}

/* Mission objective banner */
.objective-banner {
	background: linear-gradient(135deg, rgba(88, 166, 255, 0.12), rgba(188, 140, 255, 0.08));
	border-bottom: 1px solid var(--border);
	padding: 10px 20px;
	display: flex;
	align-items: center;
	gap: 10px;
	min-height: 40px;
}

.objective-banner .objective-label {
	font-size: 11px;
	font-weight: 700;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: var(--blue);
	flex-shrink: 0;
}

.objective-banner .objective-text {
	font-size: 13px;
	color: var(--text);
	line-height: 1.4;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.objective-banner.inactive {
	background: rgba(48, 54, 61, 0.3);
}

.objective-banner.inactive .objective-label {
	color: var(--text-muted);
}

.objective-banner.inactive .objective-text {
	color: var(--text-muted);
	font-style: italic;
}

/* Enhanced worker card timestamps */
.card-timestamps {
	font-size: 11px;
	color: var(--text-muted);
	margin-top: 4px;
	display: flex;
	gap: 12px;
}

.card-timestamps .ts-label {
	color: var(--text-muted);
	opacity: 0.7;
}

.card-worker-name {
	font-size: 12px;
	color: var(--purple);
	font-weight: 500;
	margin-top: 2px;
}

/* Mission History section */
.history-section {
	background: var(--surface);
	border-top: 1px solid var(--border);
}

.history-toggle {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 10px 20px;
	cursor: pointer;
	user-select: none;
	font-size: 13px;
	font-weight: 600;
	color: var(--text-muted);
	text-transform: uppercase;
	letter-spacing: 0.5px;
	border: none;
	background: none;
	width: 100%;
	text-align: left;
}

.history-toggle:hover {
	color: var(--text);
	background: rgba(255, 255, 255, 0.02);
}

.history-toggle .toggle-arrow {
	display: inline-block;
	transition: transform 0.2s ease;
	font-size: 10px;
}

.history-section.collapsed .toggle-arrow {
	transform: rotate(-90deg);
}

.history-section.collapsed .history-content {
	display: none;
}

.history-content {
	padding: 0 20px 12px 20px;
	overflow-x: auto;
}

.history-table {
	width: 100%;
	border-collapse: collapse;
	font-size: 12px;
}

.history-table th {
	text-align: left;
	color: var(--text-muted);
	font-weight: 600;
	font-size: 11px;
	text-transform: uppercase;
	letter-spacing: 0.3px;
	padding: 6px 10px;
	border-bottom: 1px solid var(--border);
}

.history-table td {
	padding: 8px 10px;
	border-bottom: 1px solid rgba(48, 54, 61, 0.5);
	color: var(--text);
	vertical-align: middle;
}

.history-table tr:hover td {
	background: rgba(255, 255, 255, 0.02);
}

.history-objective {
	max-width: 300px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.history-badge {
	display: inline-block;
	padding: 1px 6px;
	border-radius: 8px;
	font-size: 10px;
	font-weight: 600;
	text-transform: uppercase;
}

.history-badge.completed { background: rgba(63, 185, 80, 0.2); color: var(--green); }
.history-badge.failed { background: rgba(248, 81, 73, 0.2); color: var(--red); }
.history-badge.stopped { background: rgba(248, 81, 73, 0.2); color: var(--red); }
.history-badge.running { background: rgba(210, 153, 34, 0.2); color: var(--yellow); }

.history-counts {
	display: flex;
	gap: 6px;
	font-size: 11px;
}

.history-counts .hc-merged { color: var(--green); }
.history-counts .hc-failed { color: var(--red); }

.history-detail-btn {
	font-size: 11px;
	padding: 2px 8px;
	border-radius: 4px;
	border: 1px solid var(--border);
	background: transparent;
	color: var(--blue);
	cursor: pointer;
}

.history-detail-btn:hover {
	background: rgba(88, 166, 255, 0.1);
}

.history-empty {
	padding: 16px 0;
	text-align: center;
	color: var(--text-muted);
	font-size: 13px;
}
</style>
</head>
<body>

<div class="layout">
	<!-- Mission objective banner -->
	<div class="objective-banner inactive" id="objective-banner">
		<span class="objective-label">Objective</span>
		<span class="objective-text" id="objective-text">No active mission</span>
	</div>

	<!-- Header -->
	<div class="header">
		<div class="header-left">
			<h1>Mission Control</h1>
			<span class="status-badge no-mission" id="mission-status">NO MISSION</span>
		</div>
		<div class="header-stats">
			<span>Elapsed: <span class="stat-value" id="elapsed">--</span></span>
			<span>Cost: <span class="stat-value" id="cost">$0.00</span></span>
			<span>Epoch: <span class="stat-value" id="epoch-num">0</span></span>
			<span>Merged: <span class="stat-value" id="merged">0</span></span>
			<span>Failed: <span class="stat-value" id="failed-count">0</span></span>
			<span>Running: <span class="stat-value" id="running-count">0</span></span>
			<span>Pending: <span class="stat-value" id="pending-count">0</span></span>
		</div>
	</div>

	<!-- Main content -->
	<div class="main">
		<!-- Plan tree -->
		<div class="plan-tree">
			<h2>Plan Tree</h2>
			<div id="plan-tree-content"></div>
		</div>

		<!-- Worker cards -->
		<div class="workers">
			<h2>Work Units</h2>
			<div class="worker-grid" id="worker-grid"></div>
		</div>

		<!-- Event log -->
		<div class="event-log">
			<h2>Event Log</h2>
			<div class="event-filters" id="event-filters">
				<button class="event-filter-btn active" data-type="all" onclick="toggleEventFilter('all')">All</button>
				<button class="event-filter-btn active" data-type="dispatched" onclick="toggleEventFilter('dispatched')">Dispatched</button>
				<button class="event-filter-btn active" data-type="merged" onclick="toggleEventFilter('merged')">Merged</button>
				<button class="event-filter-btn active" data-type="failed" onclick="toggleEventFilter('failed')">Failed</button>
				<button class="event-filter-btn active" data-type="retry_queued" onclick="toggleEventFilter('retry_queued')">Retry</button>
				<button class="event-filter-btn active" data-type="rejected" onclick="toggleEventFilter('rejected')">Rejected</button>
				<button class="event-filter-btn active" data-type="merge_failed" onclick="toggleEventFilter('merge_failed')">Merge Fail</button>
			</div>
			<div id="event-log-content"></div>
		</div>
	</div>

	<!-- Mission History -->
	<div class="history-section collapsed" id="history-section">
		<button class="history-toggle" onclick="toggleHistory()">
			<span class="toggle-arrow">&#9662;</span>
			Mission History
		</button>
		<div class="history-content" id="history-content">
			<div class="history-empty">No mission history</div>
		</div>
	</div>

	<!-- Control bar -->
	<div class="controls">
		<button class="warning" id="btn-pause" onclick="togglePause()" disabled title="Pause mission [P]">Pause <span class="kbd-hint">P</span></button>
		<button class="danger" id="btn-stop" onclick="confirmStop()" disabled title="Stop mission [S]">Stop <span class="kbd-hint">S</span></button>
		<button id="btn-objective" onclick="openAddObjective()" disabled title="Add objective [O]">+ Objective <span class="kbd-hint">O</span></button>
		<div class="spacer"></div>
		<span class="ws-status disconnected" id="ws-status">Disconnected</span>
	</div>
</div>

<!-- Add Objective Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
	<div class="modal">
		<h3>Add Objective</h3>
		<textarea id="objective-input" placeholder="Describe the additional objective..."></textarea>
		<div class="modal-actions">
			<button onclick="closeModal()">Cancel</button>
			<button class="primary" onclick="submitObjective()">Add</button>
		</div>
	</div>
</div>

<!-- Confirmation dialog -->
<div class="confirm-overlay" id="confirm-overlay" onclick="if(event.target===this)closeConfirm()">
	<div class="confirm-dialog">
		<div class="confirm-icon" id="confirm-icon"></div>
		<h3 id="confirm-title"></h3>
		<p id="confirm-message"></p>
		<div class="confirm-actions">
			<button onclick="closeConfirm()">Cancel</button>
			<button class="confirm-danger" id="confirm-btn" onclick="executeConfirm()">Confirm</button>
		</div>
	</div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
let ws = null;
let isPaused = false;
let missionActive = false;
let unitTitles = {}; // unit_id -> title cache for event log
let expandedCards = new Set();
let pendingConfirmAction = null;

function connect() {
	const protocol = location.protocol === "https:" ? "wss:" : "ws:";
	ws = new WebSocket(`${protocol}//${location.host}/ws`);

	ws.onopen = () => {
		document.getElementById("ws-status").textContent = "Connected";
		document.getElementById("ws-status").className = "ws-status connected";
	};

	ws.onclose = () => {
		document.getElementById("ws-status").textContent = "Disconnected";
		document.getElementById("ws-status").className = "ws-status disconnected";
		setTimeout(connect, 2000);
	};

	ws.onerror = () => ws.close();

	ws.onmessage = (e) => {
		const snapshot = JSON.parse(e.data);
		if (snapshot.reload) {
			location.reload();
			return;
		}
		updateAll(snapshot);
	};
}

let workersByUnit = {};

function updateAll(snapshot) {
	// Build worker lookup by current_unit_id
	workersByUnit = {};
	if (snapshot.workers) {
		for (const w of snapshot.workers) {
			if (w.current_unit_id) {
				workersByUnit[w.current_unit_id] = w;
			}
			// Also index by worker ID (which equals unit ID in 1:1 mapping)
			workersByUnit[w.id] = w;
		}
	}
	updateHeader(snapshot.mission, snapshot.summary);
	updatePlanTree(snapshot.plan_tree);
	updateWorkerCards(snapshot.units);
	updateEventLog(snapshot.events);
	updateHistory(snapshot.history);
}

function updateHeader(mission, summary) {
	const badge = document.getElementById("mission-status");
	const elapsed = document.getElementById("elapsed");
	const cost = document.getElementById("cost");
	const epochEl = document.getElementById("epoch-num");
	const banner = document.getElementById("objective-banner");
	const objText = document.getElementById("objective-text");

	updateControlStates(mission);

	if (!mission) {
		badge.textContent = "NO MISSION";
		badge.className = "status-badge no-mission";
		banner.className = "objective-banner inactive";
		objText.textContent = "No active mission";
		return;
	}

	const status = isPaused ? "paused" : mission.status;
	badge.textContent = status.toUpperCase();
	badge.className = `status-badge ${status}`;

	// Update objective banner
	if (mission.objective) {
		banner.className = "objective-banner";
		objText.textContent = mission.objective;
		objText.title = mission.objective;
	} else {
		banner.className = "objective-banner inactive";
		objText.textContent = "No objective set";
		objText.title = "";
	}

	cost.textContent = `$${(mission.total_cost_usd || 0).toFixed(2)}`;

	if (mission.started_at) {
		const start = new Date(mission.started_at);
		const now = mission.finished_at ? new Date(mission.finished_at) : new Date();
		const diffMs = now - start;
		const mins = Math.floor(diffMs / 60000);
		const secs = Math.floor((diffMs % 60000) / 1000);
		elapsed.textContent = `${mins}m ${secs}s`;
	}

	// Update summary stats from server-side aggregation
	if (summary) {
		document.getElementById("merged").textContent = summary.units_merged || 0;
		document.getElementById("failed-count").textContent = summary.units_failed || 0;
		document.getElementById("running-count").textContent = summary.units_running || 0;
		document.getElementById("pending-count").textContent = summary.units_pending || 0;
		if (epochEl) epochEl.textContent = summary.current_epoch || 0;
	}
}

let collapsedEpochs = new Set();

function updatePlanTree(tree) {
	const container = document.getElementById("plan-tree-content");
	if (!tree || tree.length === 0) {
		container.innerHTML = '<div class="empty-state">No plan data</div>';
		return;
	}

	let html = "";
	for (const epoch of tree) {
		const children = epoch.children || [];
		const total = children.length;
		const merged = children.filter(c => c.status === "completed").length;
		const running = children.filter(c => c.status === "running").length;
		const failed = children.filter(c => c.status === "failed").length;
		const pct = total > 0 ? Math.round((merged / total) * 100) : 0;
		const isCollapsed = collapsedEpochs.has(epoch.number);
		const activeWorkers = children.filter(c => workersByUnit[c.id] && workersByUnit[c.id].status === "working").length;

		html += `<div class="epoch-node${isCollapsed ? " collapsed" : ""}">`;
		html += `<div class="epoch-header" onclick="toggleEpoch(${epoch.number})">`;
		html += `<span class="toggle">&#9662;</span>`;
		html += `<span>Epoch ${epoch.number}</span>`;
		html += `<span style="color:var(--text-muted);font-size:11px;margin-left:auto">`;
		if (activeWorkers) html += `<span style="color:var(--blue)">${activeWorkers}w</span> `;
		if (merged) html += `<span style="color:var(--green)">${merged}m</span> `;
		if (running) html += `<span style="color:var(--yellow)">${running}r</span> `;
		if (failed) html += `<span style="color:var(--red)">${failed}f</span>`;
		html += `</span>`;
		html += `</div>`;

		html += `<div class="epoch-progress"><div class="epoch-progress-fill" style="width:${pct}%"></div></div>`;

		html += `<div class="epoch-children">`;
		for (const unit of children) {
			unitTitles[unit.id] = unit.title;
			const dotClass = unit.status === "completed" ? "completed" : unit.status;
			const duration = formatUnitDuration(unit);
			html += `<div class="unit-node" onclick="scrollToCard('${unit.id}')" title="${escapeHtml(unit.title)}">`;
			html += `<span class="unit-dot ${dotClass}"></span>`;
			html += `<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(unit.title)}</span>`;
			if (duration) html += `<span class="unit-duration">${duration}</span>`;
			html += `</div>`;
		}
		html += `</div>`;

		html += `</div>`;
	}
	container.innerHTML = html;
}

function toggleEpoch(num) {
	if (collapsedEpochs.has(num)) {
		collapsedEpochs.delete(num);
	} else {
		collapsedEpochs.add(num);
	}
	const nodes = document.querySelectorAll(".epoch-node");
	for (const node of nodes) {
		const header = node.querySelector(".epoch-header");
		if (header && header.textContent.includes(`Epoch ${num}`)) {
			node.classList.toggle("collapsed");
			break;
		}
	}
}

function formatUnitDuration(unit) {
	if (!unit.started_at) return "";
	const start = new Date(unit.started_at);
	const end = unit.finished_at ? new Date(unit.finished_at) : (unit.status === "running" ? new Date() : null);
	if (!end) return "";
	const diffMs = end - start;
	const mins = Math.floor(diffMs / 60000);
	const secs = Math.floor((diffMs % 60000) / 1000);
	if (mins > 0) return `${mins}m ${secs}s`;
	return `${secs}s`;
}

function updateWorkerCards(units) {
	const grid = document.getElementById("worker-grid");
	const mergedEl = document.getElementById("merged");
	const failedEl = document.getElementById("failed-count");
	const runningEl = document.getElementById("running-count");
	const pendingEl = document.getElementById("pending-count");

	if (!units || units.length === 0) {
		grid.innerHTML = '<div class="empty-state">No work units</div>';
		return;
	}

	// Sort: running first, then pending, then completed, then failed
	const order = { running: 0, pending: 1, claimed: 1, completed: 3, failed: 4 };
	const sorted = [...units].sort((a, b) => (order[a.status] || 2) - (order[b.status] || 2));

	let merged = 0, failed = 0, running = 0, pending = 0;
	let html = "";

	for (const unit of sorted) {
		unitTitles[unit.id] = unit.title;

		if (unit.status === "completed") merged++;
		else if (unit.status === "failed") failed++;
		else if (unit.status === "running") running++;
		else if (unit.status === "pending" || unit.status === "claimed") pending++;

		const expanded = expandedCards.has(unit.id) ? "expanded" : "";
		const elapsed = unit.started_at && unit.status === "running"
			? formatElapsed(unit.started_at)
			: "";
		const worker = workersByUnit[unit.id];

		html += `<div class="worker-card ${unit.status} ${expanded}" id="card-${unit.id}" onclick="toggleCard('${unit.id}')">`;
		html += `<div class="card-header">`;
		html += `<span class="card-title" title="${escapeHtml(unit.title)}">${escapeHtml(unit.title)}</span>`;
		html += `<span class="card-status ${unit.status}">${unit.status}</span>`;
		html += `</div>`;
		if (worker && worker.name) {
			html += `<div class="card-worker-name">${escapeHtml(worker.name)}</div>`;
		} else if (worker && worker.id) {
			html += `<div class="card-worker-name">Worker ${escapeHtml(worker.id.substring(0, 8))}</div>`;
		}

		html += `<div class="card-meta">`;
		html += `${unit.id.substring(0, 8)}`;
		if (unit.attempt > 0) html += ` | attempt ${unit.attempt}/${unit.max_attempts}`;
		if (elapsed) html += ` | ${elapsed}`;
		if (unit.cost_usd > 0) html += ` | $${unit.cost_usd.toFixed(2)}`;
		html += `</div>`;

		if (worker) {
			html += `<div class="card-meta">`;
			if (worker.pid) html += `PID ${worker.pid}`;
			if (worker.workspace_path) html += ` | ${escapeHtml(worker.workspace_path.split("/").slice(-2).join("/"))}`;
			if (worker.last_heartbeat) html += ` | hb ${formatRelativeTime(worker.last_heartbeat)}`;
			html += `</div>`;
		}

		if (unit.files_hint) {
			html += `<div class="card-meta">files: ${escapeHtml(unit.files_hint.substring(0, 60))}</div>`;
		}

		html += `<div class="card-timestamps">`;
		if (unit.started_at) {
			html += `<span><span class="ts-label">Started:</span> ${formatTimestamp(unit.started_at)}</span>`;
		}
		if (unit.finished_at) {
			html += `<span><span class="ts-label">Finished:</span> ${formatTimestamp(unit.finished_at)}</span>`;
		}
		html += `</div>`;

		html += `<div class="card-summary">`;
		if (worker && worker.output_excerpt) {
			html += `<pre class="output-excerpt">${escapeHtml(worker.output_excerpt)}</pre>`;
		}
		if (unit.output_summary) html += `<p>${escapeHtml(unit.output_summary)}</p>`;
		if (unit.description) html += `<p style="margin-top:4px;color:var(--text-muted)">${escapeHtml(unit.description)}</p>`;
		html += `</div>`;

		html += `<div class="card-actions">`;
		if (unit.status === "running") {
			html += `<button class="danger" onclick="event.stopPropagation();cancelUnit('${escapeHtml(unit.id)}')">Cancel</button>`;
		}
		if (unit.status === "failed") {
			html += `<button onclick="event.stopPropagation();forceRetry('${unit.id}')">Force Retry</button>`;
		}
		html += `</div>`;

		html += `</div>`;
	}

	grid.innerHTML = html;
	mergedEl.textContent = merged;
	failedEl.textContent = failed;
	runningEl.textContent = running;
	pendingEl.textContent = pending;
}

let activeEventFilters = new Set(["all", "dispatched", "merged", "failed", "retry_queued", "rejected", "merge_failed"]);
let lastEventData = [];

function updateEventLog(events) {
	const container = document.getElementById("event-log-content");
	if (!events || events.length === 0) {
		container.innerHTML = '<div class="empty-state">No events</div>';
		lastEventData = [];
		return;
	}

	lastEventData = events;

	// Show newest first
	const reversed = [...events].reverse().slice(0, 100);

	// Group consecutive events by unit_id
	const groups = [];
	let currentGroup = null;
	for (const event of reversed) {
		if (currentGroup && currentGroup.unitId === event.work_unit_id) {
			currentGroup.events.push(event);
		} else {
			currentGroup = { unitId: event.work_unit_id, events: [event] };
			groups.push(currentGroup);
		}
	}

	let html = "";
	for (const group of groups) {
		const isMulti = group.events.length > 1;
		const unitTitle = unitTitles[group.unitId] || group.unitId.substring(0, 8);

		if (isMulti) {
			html += `<div class="event-group multi">`;
			html += `<div class="event-group-label">${escapeHtml(unitTitle)}</div>`;
		} else {
			html += `<div class="event-group">`;
		}

		for (const event of group.events) {
			const severity = getSeverityClass(event.event_type);
			const relTime = event.timestamp ? formatRelativeTime(event.timestamp) : "--";
			const evtUnitTitle = unitTitles[event.work_unit_id] || event.work_unit_id.substring(0, 8);
			const isFiltered = !activeEventFilters.has("all") && !activeEventFilters.has(event.event_type);

			html += `<div class="event-item ${severity}${isFiltered ? " filtered-out" : ""}" data-event-type="${event.event_type}" data-timestamp="${event.timestamp || ""}">`;
			html += `<span class="event-time" title="${event.timestamp ? new Date(event.timestamp).toLocaleString() : ""}">${relTime}</span>`;
			html += `<span class="event-type ${event.event_type}">${event.event_type}</span>`;
			if (!isMulti) {
				html += `<span class="event-unit" title="${escapeHtml(evtUnitTitle)}">${escapeHtml(evtUnitTitle)}</span>`;
			}
			html += `</div>`;
		}

		html += `</div>`;
	}
	container.innerHTML = html;
}

function getSeverityClass(eventType) {
	switch (eventType) {
		case "merged":
		case "research_completed":
			return "severity-success";
		case "dispatched":
			return "severity-info";
		case "retry_queued":
			return "severity-warning";
		case "failed":
		case "rejected":
		case "merge_failed":
			return "severity-error";
		default:
			return "severity-info";
	}
}

function formatRelativeTime(isoString) {
	try {
		const then = new Date(isoString);
		const diffMs = Date.now() - then.getTime();
		const diffSec = Math.floor(diffMs / 1000);
		if (diffSec < 5) return "just now";
		if (diffSec < 60) return `${diffSec}s ago`;
		const diffMin = Math.floor(diffSec / 60);
		if (diffMin < 60) return `${diffMin}m ago`;
		const diffHr = Math.floor(diffMin / 60);
		if (diffHr < 24) return `${diffHr}h ago`;
		const diffDay = Math.floor(diffHr / 24);
		return `${diffDay}d ago`;
	} catch {
		return "--";
	}
}

function refreshRelativeTimestamps() {
	const timeEls = document.querySelectorAll("#event-log-content .event-time[data-timestamp]");
	for (const el of timeEls) {
		// data-timestamp is on the parent .event-item
	}
	const items = document.querySelectorAll("#event-log-content .event-item[data-timestamp]");
	for (const item of items) {
		const ts = item.getAttribute("data-timestamp");
		if (ts) {
			const timeEl = item.querySelector(".event-time");
			if (timeEl) timeEl.textContent = formatRelativeTime(ts);
		}
	}
}

function toggleEventFilter(type) {
	if (type === "all") {
		const allBtn = document.querySelector('.event-filter-btn[data-type="all"]');
		if (activeEventFilters.has("all")) {
			// Deactivate all filters
			activeEventFilters.clear();
			document.querySelectorAll(".event-filter-btn").forEach(b => b.classList.remove("active"));
		} else {
			// Activate all filters
			activeEventFilters = new Set(["all", "dispatched", "merged", "failed", "retry_queued", "rejected", "merge_failed"]);
			document.querySelectorAll(".event-filter-btn").forEach(b => b.classList.add("active"));
		}
	} else {
		const btn = document.querySelector(`.event-filter-btn[data-type="${type}"]`);
		if (activeEventFilters.has(type)) {
			activeEventFilters.delete(type);
			btn.classList.remove("active");
		} else {
			activeEventFilters.add(type);
			btn.classList.add("active");
		}

		// Sync "all" button state
		const allTypes = ["dispatched", "merged", "failed", "retry_queued", "rejected", "merge_failed"];
		const allActive = allTypes.every(t => activeEventFilters.has(t));
		const allBtn = document.querySelector('.event-filter-btn[data-type="all"]');
		if (allActive) {
			activeEventFilters.add("all");
			allBtn.classList.add("active");
		} else {
			activeEventFilters.delete("all");
			allBtn.classList.remove("active");
		}
	}

	applyEventFilters();
}

function applyEventFilters() {
	const showAll = activeEventFilters.has("all") || activeEventFilters.size === 0;
	const items = document.querySelectorAll("#event-log-content .event-item");
	for (const item of items) {
		const type = item.getAttribute("data-event-type");
		if (showAll || activeEventFilters.has(type)) {
			item.classList.remove("filtered-out");
		} else {
			item.classList.add("filtered-out");
		}
	}

	// Hide group labels when all events in a group are filtered out
	const groups = document.querySelectorAll("#event-log-content .event-group");
	for (const group of groups) {
		const visibleItems = group.querySelectorAll(".event-item:not(.filtered-out)");
		group.style.display = visibleItems.length === 0 ? "none" : "";
	}
}

// Control actions
async function sendSignal(type, payload = {}) {
	try {
		await fetch("/api/signal", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ signal_type: type, payload }),
		});
	} catch (e) {
		console.error("Failed to send signal:", e);
		showToast("Failed to send signal", "warn");
	}
}

function togglePause() {
	if (!missionActive) return;
	if (isPaused) {
		sendSignal("resume");
		isPaused = false;
		const btn = document.getElementById("btn-pause");
		btn.innerHTML = 'Pause <span class="kbd-hint">P</span>';
		showToast("Resume signal sent", "info");
	} else {
		sendSignal("pause");
		isPaused = true;
		const btn = document.getElementById("btn-pause");
		btn.innerHTML = 'Resume <span class="kbd-hint">P</span>';
		showToast("Pause signal sent", "info");
	}
}

function confirmStop() {
	if (!missionActive) return;
	showConfirm("Stop Mission", "This will stop all running workers and end the mission. This action cannot be undone.", function() {
		sendSignal("stop");
		showToast("Stop requested", "warn");
	});
}

function cancelUnit(unitId) {
	const title = unitTitles[unitId] || unitId.substring(0, 8);
	showConfirm("Cancel Unit", `Cancel work unit "${title}"? The worker will be terminated.`, function() {
		sendSignal("cancel_unit", { unit_id: unitId });
		showToast("Cancel signal sent for " + title, "info");
	});
}

function forceRetry(unitId) {
	sendSignal("force_retry", { unit_id: unitId });
	const title = unitTitles[unitId] || unitId.substring(0, 8);
	showToast("Retry queued for " + title, "info");
}

// Confirmation dialog
function showConfirm(title, message, onConfirm) {
	document.getElementById("confirm-title").textContent = title;
	document.getElementById("confirm-message").textContent = message;
	pendingConfirmAction = onConfirm;
	document.getElementById("confirm-overlay").classList.add("active");
}

function closeConfirm() {
	document.getElementById("confirm-overlay").classList.remove("active");
	pendingConfirmAction = null;
}

function executeConfirm() {
	if (pendingConfirmAction) pendingConfirmAction();
	closeConfirm();
}

// Toast notifications
function showToast(message, type) {
	type = type || "info";
	const container = document.getElementById("toast-container");
	const toast = document.createElement("div");
	toast.className = "toast " + type;
	toast.textContent = message;
	container.appendChild(toast);
	setTimeout(function() { toast.remove(); }, 2600);
}

// Button state management
function updateControlStates(mission) {
	const active = mission && (mission.status === "running" || mission.status === "paused");
	missionActive = active;
	document.getElementById("btn-pause").disabled = !active;
	document.getElementById("btn-stop").disabled = !active;
	document.getElementById("btn-objective").disabled = !active;
}

// Keyboard shortcuts
document.addEventListener("keydown", function(e) {
	// Ignore when typing in inputs/textareas
	if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
	// Ignore with modifier keys
	if (e.ctrlKey || e.metaKey || e.altKey) return;

	// Close confirm dialog on Escape
	if (e.key === "Escape") {
		if (document.getElementById("confirm-overlay").classList.contains("active")) {
			closeConfirm();
			return;
		}
		if (document.getElementById("modal-overlay").classList.contains("active")) {
			closeModal();
			return;
		}
		return;
	}

	if (e.key === "p" || e.key === "P") {
		e.preventDefault();
		togglePause();
	} else if (e.key === "s" || e.key === "S") {
		e.preventDefault();
		confirmStop();
	} else if (e.key === "o" || e.key === "O") {
		e.preventDefault();
		if (missionActive) openAddObjective();
	}
});

function openAddObjective() {
	document.getElementById("modal-overlay").classList.add("active");
	document.getElementById("objective-input").focus();
}

function closeModal(event) {
	if (!event || event.target === document.getElementById("modal-overlay")) {
		document.getElementById("modal-overlay").classList.remove("active");
		document.getElementById("objective-input").value = "";
	}
}

function submitObjective() {
	const text = document.getElementById("objective-input").value.trim();
	if (text) {
		sendSignal("add_objective", { objective: text });
		closeModal();
	}
}

// Helpers
function toggleCard(id) {
	if (expandedCards.has(id)) {
		expandedCards.delete(id);
	} else {
		expandedCards.add(id);
	}
	const card = document.getElementById(`card-${id}`);
	if (card) card.classList.toggle("expanded");
}

function scrollToCard(id) {
	const card = document.getElementById(`card-${id}`);
	if (card) {
		card.scrollIntoView({ behavior: "smooth", block: "center" });
		if (!expandedCards.has(id)) toggleCard(id);
		card.style.borderColor = "var(--blue)";
		setTimeout(() => card.style.borderColor = "", 2000);
	}
}

function formatElapsed(isoString) {
	const start = new Date(isoString);
	const diff = Date.now() - start.getTime();
	const mins = Math.floor(diff / 60000);
	if (mins < 1) return "<1m";
	return `${mins}m`;
}

function formatTime(isoString) {
	try {
		const d = new Date(isoString);
		return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
	} catch {
		return "--:--";
	}
}

function escapeHtml(text) {
	if (!text) return "";
	const div = document.createElement("div");
	div.textContent = text;
	return div.innerHTML;
}

function formatTimestamp(isoString) {
	if (!isoString) return "--";
	try {
		const d = new Date(isoString);
		return d.toLocaleString([], {
			month: "short", day: "numeric",
			hour: "2-digit", minute: "2-digit", second: "2-digit"
		});
	} catch {
		return "--";
	}
}

function formatDuration(startIso, endIso) {
	if (!startIso) return "--";
	try {
		const start = new Date(startIso);
		const end = endIso ? new Date(endIso) : new Date();
		const diffMs = end - start;
		const hrs = Math.floor(diffMs / 3600000);
		const mins = Math.floor((diffMs % 3600000) / 60000);
		if (hrs > 0) return `${hrs}h ${mins}m`;
		return `${mins}m`;
	} catch {
		return "--";
	}
}

function toggleHistory() {
	const section = document.getElementById("history-section");
	section.classList.toggle("collapsed");
}

function updateHistory(history) {
	const container = document.getElementById("history-content");
	if (!history || history.length === 0) {
		container.innerHTML = '<div class="history-empty">No mission history</div>';
		return;
	}

	let html = '<table class="history-table">';
	html += '<thead><tr>';
	html += '<th>Objective</th><th>Status</th><th>Units</th><th>Duration</th><th>Cost</th><th></th>';
	html += '</tr></thead><tbody>';

	for (const m of history) {
		const objective = m.objective || "Untitled mission";
		const truncated = objective.length > 80 ? objective.substring(0, 77) + "..." : objective;
		const statusClass = m.status || "completed";
		const merged = m.units_merged || 0;
		const failed = m.units_failed || 0;
		const total = m.units_total || (merged + failed);
		const duration = formatDuration(m.started_at, m.finished_at);
		const cost = m.total_cost_usd != null ? `$${m.total_cost_usd.toFixed(2)}` : "--";

		html += `<tr>`;
		html += `<td><span class="history-objective" title="${escapeHtml(objective)}">${escapeHtml(truncated)}</span></td>`;
		html += `<td><span class="history-badge ${statusClass}">${statusClass}</span></td>`;
		html += `<td><span class="history-counts">`;
		html += `<span class="hc-merged">${merged}m</span>`;
		if (failed > 0) html += ` <span class="hc-failed">${failed}f</span>`;
		html += ` / ${total}`;
		html += `</span></td>`;
		html += `<td>${duration}</td>`;
		html += `<td>${cost}</td>`;
		html += `<td>`;
		if (m.id) {
			html += `<button class="history-detail-btn" onclick="event.stopPropagation();viewMissionDetail('${escapeHtml(m.id)}')">Details</button>`;
		}
		html += `</td>`;
		html += `</tr>`;
	}

	html += '</tbody></table>';
	container.innerHTML = html;
}

function viewMissionDetail(missionId) {
	showToast("Mission details: " + missionId.substring(0, 8), "info");
}

// Update relative timestamps every 15 seconds
setInterval(refreshRelativeTimestamps, 15000);

// Start
connect();
</script>
</body>
</html>
